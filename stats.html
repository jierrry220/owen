<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debear Party - æ•°æ®ç»Ÿè®¡</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:#0f172a; color:#e2e8f0; margin:0; padding:0; }
    .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
    .header { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:20px; margin-bottom:16px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .btn { background:#4f46e5; color:#fff; border:0; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.2s; }
    .btn:hover { opacity:0.9; }
    .btn.secondary { background:#10b981; }
    .card { background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:20px; margin-bottom:16px; }
    .card h2 { margin:0 0 16px; font-size:20px; }
    .muted { color:#9ca3af; font-size:13px; }
    a { color:#93c5fd; text-decoration:none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="row">
        <h1 style="margin:0; font-size:24px; color:#bfdbfe;">ğŸ“Š Debear Party - æ•°æ®ç»Ÿè®¡</h1>
        <div style="flex:1"></div>
        <a href="admin.html" style="text-decoration:none;">
          <button class="btn">ğŸ› ï¸ è¿”å›æ§åˆ¶å°</button>
        </a>
      </div>
      <div class="muted" style="margin-top:8px;">å®æ—¶åŒºå—é“¾æ•°æ®æŸ¥è¯¢ | Berachain ä¸»ç½‘</div>
    </div>

    <!-- NFT çŸ¿æ± æµå‡ºè®°å½• -->
    <div class="card" style="border:2px solid #3b82f6;">
      <h2 style="color:#93c5fd;">ğŸ“Š NFT çŸ¿æ± æµå‡ºè®°å½•ï¼ˆç”¨æˆ· Claimï¼‰</h2>
      <div class="row" style="margin-bottom:12px; gap:8px;">
        <button class="btn secondary" onclick="loadNFTClaims()">ğŸ”„ åˆ·æ–°</button>
        <span class="muted" style="flex:1;">NFT çŸ¿æ± ï¼š<span style="font-family:monospace; font-size:11px;">0x0D9b...2097</span></span>
      </div>
      <div style="max-height:700px; overflow-y:auto; border:1px solid #374151; border-radius:8px; padding:12px; background:#0d1117;" id="nftClaimsContainer">
        <div style="padding:20px; text-align:center; color:#6b7280;">åŠ è½½ä¸­...</div>
      </div>
      <div class="muted" style="margin-top:8px; font-size:14px;" id="nftClaimsStats">æ€»è®¡ï¼š--</div>
    </div>

    <!-- T-Engine æŠ•å…¥ & é¢†å–è®°å½• -->
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); gap:16px;">
      <!-- T-Engine æŠ•å…¥è®°å½• -->
      <div class="card" style="border:2px solid #a78bfa;">
        <h2 style="color:#c4b5fd;">â›ï¸ T-Engine æŠ•å…¥è®°å½•ï¼ˆDepositï¼‰</h2>
        <div class="row" style="margin-bottom:12px; gap:8px;">
          <button class="btn" style="background:#a78bfa;" onclick="loadTEngineDeposits()">ğŸ”„ åˆ·æ–°</button>
          <span class="muted" style="flex:1;">T-Engineï¼š<span style="font-family:monospace; font-size:11px;">0xd966...81D8</span></span>
        </div>
        <div style="max-height:700px; overflow-y:auto; border:1px solid #374151; border-radius:8px; padding:12px; background:#0d1117;" id="tEngineDepositsContainer">
          <div style="padding:20px; text-align:center; color:#6b7280;">åŠ è½½ä¸­...</div>
        </div>
        <div class="muted" style="margin-top:8px; font-size:14px;" id="tEngineDepositsStats">æ€»è®¡ï¼š--</div>
      </div>

      <!-- T-Engine é¢†å–è®°å½• -->
      <div class="card" style="border:2px solid #10b981;">
        <h2 style="color:#6ee7b7;">â›ï¸ T-Engine é¢†å–è®°å½•ï¼ˆClaimï¼‰</h2>
        <div class="row" style="margin-bottom:12px; gap:8px;">
          <button class="btn secondary" onclick="loadTEngineClaims()">ğŸ”„ åˆ·æ–°</button>
          <span class="muted" style="flex:1;">T-Engineï¼š<span style="font-family:monospace; font-size:11px;">0xd966...81D8</span></span>
        </div>
        <div style="max-height:700px; overflow-y:auto; border:1px solid #374151; border-radius:8px; padding:12px; background:#0d1117;" id="tEngineClaimsContainer">
          <div style="padding:20px; text-align:center; color:#6b7280;">åŠ è½½ä¸­...</div>
        </div>
        <div class="muted" style="margin-top:8px; font-size:14px;" id="tEngineClaimsStats">æ€»è®¡ï¼š--</div>
      </div>
    </div>

    <div class="muted" style="text-align:center; padding:20px 0;">
      <p>ğŸ’¡ æ•°æ®æ¯3ç§’è‡ªåŠ¨æ‰¹é‡åŠ è½½ï¼Œé»˜è®¤åŠ è½½æœ€è¿‘3å¤©å†å²è®°å½•</p>
      <p>ğŸ”— ç‚¹å‡»äº¤æ˜“é“¾æ¥å¯åœ¨ <a href="https://berascan.com" target="_blank">Berascan</a> æŸ¥çœ‹è¯¦æƒ…</p>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // NFT Claims
    let nftClaimsAllData = [];
    let nftClaimsBatchCount = 0;
    let nftClaimsLoadingState = { active: false, targetDays: 3, startBatch: 0, startDayCount: 0 };

    function getNFTClaimsDayCount() {
      if (nftClaimsAllData.length === 0) return 0;
      const dates = new Set(nftClaimsAllData.map(r => new Date(r.timestamp * 1000).toISOString().split('T')[0]));
      return dates.size;
    }

    async function loadNFTClaimsBatch() {
      try {
        const fromBlockOffset = nftClaimsBatchCount * 9900; // ä¿®æ­£: ç¬¬0æ‰¹ä»0å¼€å§‹
        console.log(`ğŸ”„ NFT Claims æ‰¹æ¬¡ ${nftClaimsBatchCount + 1}, offset=${fromBlockOffset}`);

        const res = await fetch(`/api/pool-flows?type=nft-claims&limit=10000&fromBlockOffset=${fromBlockOffset}`);
        const json = await res.json();

        nftClaimsBatchCount++;

        if (!json.success || !json.data || json.data.length === 0) {
          console.log(`âš ï¸ NFT Claims æ‰¹æ¬¡ ${nftClaimsBatchCount}: æ²¡æœ‰æ•°æ®`);
        } else {
          const existingHashes = new Set(nftClaimsAllData.map(r => r.txHash));
          const newRecords = json.data.filter(r => !existingHashes.has(r.txHash));
          nftClaimsAllData.push(...newRecords);
          console.log(`âœ… NFT Claims æ‰¹æ¬¡ ${nftClaimsBatchCount}: åŠ è½½ ${newRecords.length} æ¡ï¼Œæ€»è®¡ ${nftClaimsAllData.length} æ¡`);
        }

        renderNFTClaims();

        const currentDays = getNFTClaimsDayCount();
        const newDays = currentDays - nftClaimsLoadingState.startDayCount;
        const batchesLoaded = nftClaimsBatchCount - nftClaimsLoadingState.startBatch;
        const targetDays = nftClaimsLoadingState.targetDays;

        console.log(`ğŸ“Š NFT Claims: æ€»å…± ${currentDays} å¤©ï¼Œæœ¬æ¬¡æ–°å¢ ${newDays} å¤©ï¼Œç›®æ ‡ ${targetDays} å¤©`);

        if (newDays >= targetDays) {
          console.log(`âœ… NFT Claims: æœ¬æ¬¡å·²åŠ è½½ ${newDays} å¤©ï¼Œè¾¾åˆ°ç›®æ ‡ï¼Œåœæ­¢`);
          nftClaimsLoadingState.active = false;
          renderNFTClaims();
          return false;
        }

        if (nftClaimsLoadingState.active) {
          const delay = batchesLoaded < 5 ? 1000 : 3000;
          setTimeout(loadNFTClaimsBatch, delay);
        }

        return true;
      } catch (error) {
        console.error(`âŒ NFT Claims æ‰¹æ¬¡å¤±è´¥:`, error);
        nftClaimsBatchCount++;
        if (nftClaimsLoadingState.active) {
          const batchesLoaded = nftClaimsBatchCount - nftClaimsLoadingState.startBatch;
          const delay = batchesLoaded < 5 ? 1000 : 3000;
          setTimeout(loadNFTClaimsBatch, delay);
        }
        return false;
      }
    }

    function renderNFTClaims() {
      const container = $('nftClaimsContainer');

      if (nftClaimsAllData.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:#6b7280;">æš‚æ— è®°å½•</div>';
        $('nftClaimsStats').textContent = 'æ€»è®¡ï¼š0 ç¬”';
        return;
      }

      const groupedByDate = {};
      nftClaimsAllData.forEach(record => {
        const dateKey = new Date(record.timestamp * 1000).toISOString().split('T')[0];
        if (!groupedByDate[dateKey]) groupedByDate[dateKey] = [];
        groupedByDate[dateKey].push(record);
      });

      const sortedDates = Object.keys(groupedByDate).sort((a, b) => b.localeCompare(a));
      let totalCount = 0, totalAmount = 0;

      const html = sortedDates.map(dateKey => {
        const records = groupedByDate[dateKey];
        const dayName = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][new Date(dateKey).getDay()];
        let dayTotal = 0;

        const rows = records.map(record => {
          const amount = parseFloat(record.amount);
          dayTotal += amount;
          totalCount++;
          totalAmount += amount;
          const timeStr = new Date(record.timestamp * 1000).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          const explorerUrl = `https://berascan.com/tx/${record.txHash}`;
          return `<div style="display:flex; align-items:center; padding:8px; border-bottom:1px solid #1f2937; font-size:12px;">
            <div style="flex:0 0 80px; color:#9ca3af;">${timeStr}</div>
            <div style="flex:1; font-family:monospace; color:#93c5fd;">${record.to.slice(0,6)}...${record.to.slice(-4)}</div>
            <div style="flex:0 0 120px; text-align:right; color:#fbbf24; font-weight:600;">${amount.toLocaleString()} DP</div>
            <div style="flex:0 0 40px; text-align:center;"><a href="${explorerUrl}" target="_blank" style="color:#60a5fa; text-decoration:none;">ğŸ”—</a></div>
          </div>`;
        }).join('');

        return `<div style="margin-bottom:16px;">
          <div style="background:#0f172a; padding:10px; border-radius:8px 8px 0 0; border-bottom:2px solid #3b82f6;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="font-size:14px; font-weight:600; color:#93c5fd;">ğŸ“… ${dateKey} (${dayName})</div>
              <div style="font-size:13px; color:#9ca3af;">${records.length} ç¬” | ${dayTotal.toLocaleString()} DP</div>
            </div>
          </div>
          <div style="background:#111827; border-radius:0 0 8px 8px;">${rows}</div>
        </div>`;
      }).join('');

      const currentDays = getNFTClaimsDayCount();
      let footer = '';
      if (nftClaimsLoadingState.active) {
        footer = `<div style="padding:10px; text-align:center; color:#9ca3af; font-size:12px;">ğŸ”„ æ­£åœ¨åŠ è½½æ›´å¤šæ•°æ®... (å·²æœ‰ ${currentDays} å¤©)</div>`;
      } else {
        footer = `<div style="padding:10px; text-align:center;">
          <div style="color:#9ca3af; font-size:12px; margin-bottom:8px;">å·²åŠ è½½ ${currentDays} å¤©å†å²æ•°æ®</div>
          <button onclick="loadMoreNFTClaims()" style="padding:6px 16px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px;">ğŸ“¥ åŠ è½½æ›´å¤š (3å¤©)</button>
        </div>`;
      }

      container.innerHTML = html + footer;
      $('nftClaimsStats').textContent = `æ€»è®¡ï¼š${totalCount} ç¬” | æ€»é¢ï¼š${totalAmount.toLocaleString()} DP`;
    }

    async function loadNFTClaims() {
      nftClaimsAllData = [];
      nftClaimsBatchCount = 0;
      nftClaimsLoadingState = { active: true, targetDays: 3, startBatch: 0, startDayCount: 0 };
      $('nftClaimsContainer').innerHTML = '<div style="padding:20px; text-align:center; color:#6b7280;">ğŸ”„ åŠ è½½ä¸­...</div>';
      await loadNFTClaimsBatch();
    }

    async function loadMoreNFTClaims() {
      const currentDays = getNFTClaimsDayCount();
      nftClaimsLoadingState = { active: true, targetDays: 3, startBatch: nftClaimsBatchCount, startDayCount: currentDays };
      renderNFTClaims();
      await loadNFTClaimsBatch();
    }

    // T-Engine Deposits (ç±»ä¼¼ç»“æ„)
    let tEngineDepositsAllData = [];
    let tEngineDepositsBatchCount = 0;
    let tEngineDepositsLoadingState = { active: false, targetDays: 3, startBatch: 0, startDayCount: 0 };

    function getTEngineDepositsDayCount() {
      if (tEngineDepositsAllData.length === 0) return 0;
      const dates = new Set(tEngineDepositsAllData.map(r => new Date(r.timestamp * 1000).toISOString().split('T')[0]));
      return dates.size;
    }

    async function loadTEngineDepositsBatch() {
      try {
        const fromBlockOffset = tEngineDepositsBatchCount * 9900; // ä¿®æ­£: ç¬¬0æ‰¹ä»0å¼€å§‹
        const res = await fetch(`/api/pool-flows?type=tengine-deposits&limit=10000&fromBlockOffset=${fromBlockOffset}`);
        const json = await res.json();
        tEngineDepositsBatchCount++;

        if (!json.success || !json.data || json.data.length === 0) {
          console.log(`âš ï¸ T-Engine Deposits æ‰¹æ¬¡ ${tEngineDepositsBatchCount}: æ²¡æœ‰æ•°æ®`);
        } else {
          const existingHashes = new Set(tEngineDepositsAllData.map(r => r.txHash));
          const newRecords = json.data.filter(r => !existingHashes.has(r.txHash));
          tEngineDepositsAllData.push(...newRecords);
        }

        renderTEngineDeposits();

        const currentDays = getTEngineDepositsDayCount();
        const newDays = currentDays - tEngineDepositsLoadingState.startDayCount;
        const targetDays = tEngineDepositsLoadingState.targetDays;

        if (newDays >= targetDays) {
          tEngineDepositsLoadingState.active = false;
          renderTEngineDeposits();
          return false;
        }

        if (tEngineDepositsLoadingState.active) {
          const batchesLoaded = tEngineDepositsBatchCount - tEngineDepositsLoadingState.startBatch;
          const delay = batchesLoaded < 5 ? 1000 : 3000;
          setTimeout(loadTEngineDepositsBatch, delay);
        }
        return true;
      } catch (error) {
        console.error(`âŒ T-Engine Deposits å¤±è´¥:`, error);
        return false;
      }
    }

    function renderTEngineDeposits() {
      const container = $('tEngineDepositsContainer');
      if (tEngineDepositsAllData.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:#6b7280;">æš‚æ— è®°å½•</div>';
        $('tEngineDepositsStats').textContent = 'æ€»è®¡ï¼š0 ç¬”';
        return;
      }

      const groupedByDate = {};
      tEngineDepositsAllData.forEach(record => {
        const dateKey = new Date(record.timestamp * 1000).toISOString().split('T')[0];
        if (!groupedByDate[dateKey]) groupedByDate[dateKey] = [];
        groupedByDate[dateKey].push(record);
      });

      const sortedDates = Object.keys(groupedByDate).sort((a, b) => b.localeCompare(a));
      let totalCount = 0, totalAmount = 0;

      const html = sortedDates.map(dateKey => {
        const records = groupedByDate[dateKey];
        const dayName = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][new Date(dateKey).getDay()];
        let dayTotal = 0;

        const rows = records.map(record => {
          const amount = parseFloat(record.amount);
          dayTotal += amount;
          totalCount++;
          totalAmount += amount;
          const timeStr = new Date(record.timestamp * 1000).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          const explorerUrl = `https://berascan.com/tx/${record.txHash}`;
          return `<div style="display:flex; align-items:center; padding:8px; border-bottom:1px solid #1f2937; font-size:12px;">
            <div style="flex:0 0 80px; color:#9ca3af;">${timeStr}</div>
            <div style="flex:1; font-family:monospace; color:#c4b5fd;">${record.from.slice(0,6)}...${record.from.slice(-4)}</div>
            <div style="flex:0 0 120px; text-align:right; color:#a78bfa; font-weight:600;">${amount.toLocaleString()} DP</div>
            <div style="flex:0 0 40px; text-align:center;"><a href="${explorerUrl}" target="_blank" style="color:#60a5fa; text-decoration:none;">ğŸ”—</a></div>
          </div>`;
        }).join('');

        return `<div style="margin-bottom:16px;">
          <div style="background:#0f172a; padding:10px; border-radius:8px 8px 0 0; border-bottom:2px solid #a78bfa;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="font-size:14px; font-weight:600; color:#c4b5fd;">ğŸ“… ${dateKey} (${dayName})</div>
              <div style="font-size:13px; color:#9ca3af;">${records.length} ç¬” | ${dayTotal.toLocaleString()} DP</div>
            </div>
          </div>
          <div style="background:#111827; border-radius:0 0 8px 8px;">${rows}</div>
        </div>`;
      }).join('');

      const currentDays = getTEngineDepositsDayCount();
      let footer = '';
      if (tEngineDepositsLoadingState.active) {
        footer = `<div style="padding:10px; text-align:center; color:#9ca3af; font-size:12px;">ğŸ”„ æ­£åœ¨åŠ è½½æ›´å¤šæ•°æ®... (å·²æœ‰ ${currentDays} å¤©)</div>`;
      } else {
        footer = `<div style="padding:10px; text-align:center;">
          <div style="color:#9ca3af; font-size:12px; margin-bottom:8px;">å·²åŠ è½½ ${currentDays} å¤©å†å²æ•°æ®</div>
          <button onclick="loadMoreTEngineDeposits()" style="padding:6px 16px; background:#a78bfa; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px;">ğŸ“¥ åŠ è½½æ›´å¤š (3å¤©)</button>
        </div>`;
      }

      container.innerHTML = html + footer;
      $('tEngineDepositsStats').textContent = `æ€»è®¡ï¼š${totalCount} ç¬” | æ€»é¢ï¼š${totalAmount.toLocaleString()} DP`;
    }

    async function loadTEngineDeposits() {
      tEngineDepositsAllData = [];
      tEngineDepositsBatchCount = 0;
      tEngineDepositsLoadingState = { active: true, targetDays: 3, startBatch: 0, startDayCount: 0 };
      $('tEngineDepositsContainer').innerHTML = '<div style="padding:20px; text-align:center; color:#6b7280;">ğŸ”„ åŠ è½½ä¸­...</div>';
      await loadTEngineDepositsBatch();
    }

    async function loadMoreTEngineDeposits() {
      const currentDays = getTEngineDepositsDayCount();
      tEngineDepositsLoadingState = { active: true, targetDays: 3, startBatch: tEngineDepositsBatchCount, startDayCount: currentDays };
      renderTEngineDeposits();
      await loadTEngineDepositsBatch();
    }

    // T-Engine Claims (ç±»ä¼¼ç»“æ„)
    let tEngineClaimsAllData = [];
    let tEngineClaimsBatchCount = 0;
    let tEngineClaimsLoadingState = { active: false, targetDays: 3, startBatch: 0, startDayCount: 0 };

    function getTEngineClaimsDayCount() {
      if (tEngineClaimsAllData.length === 0) return 0;
      const dates = new Set(tEngineClaimsAllData.map(r => new Date(r.timestamp * 1000).toISOString().split('T')[0]));
      return dates.size;
    }

    async function loadTEngineClaimsBatch() {
      try {
        const fromBlockOffset = tEngineClaimsBatchCount * 9900; // ä¿®æ­£: ç¬¬0æ‰¹ä»0å¼€å§‹
        const res = await fetch(`/api/pool-flows?type=tengine-claims&limit=10000&fromBlockOffset=${fromBlockOffset}`);
        const json = await res.json();
        tEngineClaimsBatchCount++;

        if (!json.success || !json.data || json.data.length === 0) {
          console.log(`âš ï¸ T-Engine Claims æ‰¹æ¬¡ ${tEngineClaimsBatchCount}: æ²¡æœ‰æ•°æ®`);
        } else {
          const existingHashes = new Set(tEngineClaimsAllData.map(r => r.txHash));
          const newRecords = json.data.filter(r => !existingHashes.has(r.txHash));
          tEngineClaimsAllData.push(...newRecords);
        }

        renderTEngineClaims();

        const currentDays = getTEngineClaimsDayCount();
        const newDays = currentDays - tEngineClaimsLoadingState.startDayCount;
        const targetDays = tEngineClaimsLoadingState.targetDays;

        if (newDays >= targetDays) {
          tEngineClaimsLoadingState.active = false;
          renderTEngineClaims();
          return false;
        }

        if (tEngineClaimsLoadingState.active) {
          const batchesLoaded = tEngineClaimsBatchCount - tEngineClaimsLoadingState.startBatch;
          const delay = batchesLoaded < 5 ? 1000 : 3000;
          setTimeout(loadTEngineClaimsBatch, delay);
        }
        return true;
      } catch (error) {
        console.error(`âŒ T-Engine Claims å¤±è´¥:`, error);
        return false;
      }
    }

    function renderTEngineClaims() {
      const container = $('tEngineClaimsContainer');
      if (tEngineClaimsAllData.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:#6b7280;">æš‚æ— è®°å½•</div>';
        $('tEngineClaimsStats').textContent = 'æ€»è®¡ï¼š0 ç¬”';
        return;
      }

      const groupedByDate = {};
      tEngineClaimsAllData.forEach(record => {
        const dateKey = new Date(record.timestamp * 1000).toISOString().split('T')[0];
        if (!groupedByDate[dateKey]) groupedByDate[dateKey] = [];
        groupedByDate[dateKey].push(record);
      });

      const sortedDates = Object.keys(groupedByDate).sort((a, b) => b.localeCompare(a));
      let totalCount = 0, totalAmount = 0;

      const html = sortedDates.map(dateKey => {
        const records = groupedByDate[dateKey];
        const dayName = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][new Date(dateKey).getDay()];
        let dayTotal = 0;

        const rows = records.map(record => {
          const amount = parseFloat(record.amount);
          dayTotal += amount;
          totalCount++;
          totalAmount += amount;
          const timeStr = new Date(record.timestamp * 1000).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          const explorerUrl = `https://berascan.com/tx/${record.txHash}`;
          return `<div style="display:flex; align-items:center; padding:8px; border-bottom:1px solid #1f2937; font-size:12px;">
            <div style="flex:0 0 80px; color:#9ca3af;">${timeStr}</div>
            <div style="flex:1; font-family:monospace; color:#6ee7b7;">${record.to.slice(0,6)}...${record.to.slice(-4)}</div>
            <div style="flex:0 0 120px; text-align:right; color:#10b981; font-weight:600;">${amount.toLocaleString()} DP</div>
            <div style="flex:0 0 40px; text-align:center;"><a href="${explorerUrl}" target="_blank" style="color:#60a5fa; text-decoration:none;">ğŸ”—</a></div>
          </div>`;
        }).join('');

        return `<div style="margin-bottom:16px;">
          <div style="background:#0f172a; padding:10px; border-radius:8px 8px 0 0; border-bottom:2px solid #10b981;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="font-size:14px; font-weight:600; color:#6ee7b7;">ğŸ“… ${dateKey} (${dayName})</div>
              <div style="font-size:13px; color:#9ca3af;">${records.length} ç¬” | ${dayTotal.toLocaleString()} DP</div>
            </div>
          </div>
          <div style="background:#111827; border-radius:0 0 8px 8px;">${rows}</div>
        </div>`;
      }).join('');

      const currentDays = getTEngineClaimsDayCount();
      let footer = '';
      if (tEngineClaimsLoadingState.active) {
        footer = `<div style="padding:10px; text-align:center; color:#9ca3af; font-size:12px;">ğŸ”„ æ­£åœ¨åŠ è½½æ›´å¤šæ•°æ®... (å·²æœ‰ ${currentDays} å¤©)</div>`;
      } else {
        footer = `<div style="padding:10px; text-align:center;">
          <div style="color:#9ca3af; font-size:12px; margin-bottom:8px;">å·²åŠ è½½ ${currentDays} å¤©å†å²æ•°æ®</div>
          <button onclick="loadMoreTEngineClaims()" style="padding:6px 16px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px;">ğŸ“¥ åŠ è½½æ›´å¤š (3å¤©)</button>
        </div>`;
      }

      container.innerHTML = html + footer;
      $('tEngineClaimsStats').textContent = `æ€»è®¡ï¼š${totalCount} ç¬” | æ€»é¢ï¼š${totalAmount.toLocaleString()} DP`;
    }

    async function loadTEngineClaims() {
      tEngineClaimsAllData = [];
      tEngineClaimsBatchCount = 0;
      tEngineClaimsLoadingState = { active: true, targetDays: 3, startBatch: 0, startDayCount: 0 };
      $('tEngineClaimsContainer').innerHTML = '<div style="padding:20px; text-align:center; color:#6b7280;">ğŸ”„ åŠ è½½ä¸­...</div>';
      await loadTEngineClaimsBatch();
    }

    async function loadMoreTEngineClaims() {
      const currentDays = getTEngineClaimsDayCount();
      tEngineClaimsLoadingState = { active: true, targetDays: 3, startBatch: tEngineClaimsBatchCount, startDayCount: currentDays };
      renderTEngineClaims();
      await loadTEngineClaimsBatch();
    }

    // é¡µé¢åˆå§‹åŒ– - è‡ªåŠ¨åŠ è½½æ‰€æœ‰æ•°æ®
    console.log('ğŸ“Š Debear Party - æ•°æ®ç»Ÿè®¡é¡µé¢');
    Promise.all([
      loadNFTClaims(),
      loadTEngineDeposits(),
      loadTEngineClaims()
    ]).then(() => {
      console.log('âœ… æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ');
    }).catch(err => {
      console.warn('âš ï¸ éƒ¨åˆ†æ•°æ®åŠ è½½å¤±è´¥:', err);
    });
  </script>
</body>
</html>
