<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debear Party - Owner æ§åˆ¶å°</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; background:#0f172a; color:#e2e8f0; margin:0; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .header { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:20px; margin-bottom:16px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .btn { background:#4f46e5; color:#fff; border:0; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn.secondary { background:#10b981; }
    .btn.warning { background:#f59e0b; }
    .btn.danger { background:#ef4444; }
    .card { background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:16px; margin-top:16px; }
    .card h2 { margin:0 0 12px; font-size:18px; color:#93c5fd; }
    .grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .group { margin-bottom:12px; }
    .group label { display:block; font-size:13px; color:#9ca3af; margin-bottom:6px; }
    .group input, .group select { width:100%; padding:10px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:#e5e7eb; }
    .switch { display:flex; align-items:center; gap:8px; }
    .switch input { width:auto; }
    .muted { color:#9ca3af; font-size:12px; }
    .stat { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #1f2937; font-size:14px; }
    .stat:last-child { border-bottom:0; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#111827; border:1px solid #1f2937; font-size:12px; color:#9ca3af; }
    .msg { margin-top:10px; font-size:13px; }
    a { color:#93c5fd; text-decoration:none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="row">
        <h1 style="margin:0; font-size:22px; color:#bfdbfe;">ğŸ› ï¸ Debear Party - Owner æ§åˆ¶å°</h1>
        <span class="pill" id="ownerBadge">æœªè¿æ¥</span>
        <div style="flex:1 1 auto"></div>
        <a href="stats.html" target="_blank" style="text-decoration:none;">
          <button class="btn" style="background:#3b82f6;">ğŸ“Š æ•°æ®ç»Ÿè®¡</button>
        </a>
        <button class="btn" id="connectBtn">è¿æ¥é’±åŒ…</button>
      </div>
      <div class="row" style="margin-top:8px; gap:16px;">
        <div class="muted">é’±åŒ…: <span id="walletAddr">--</span></div>
        <div class="muted">ç½‘ç»œ: Berachain ä¸»ç½‘ (80094)</div>
      </div>
    </div>

    <!-- çŸ¿æ± ä½™é¢å¡ç‰‡ -->
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-top:12px;">
      <div class="card" style="background:#1e293b;">
        <h2 style="color:#fbbf24;">ğŸ’° NFT æŒ–çŸ¿æ± ä½™é¢</h2>
        <div style="font-size:28px; font-weight:700; color:#fcd34d; margin:16px 0;" id="nftPoolBalance">-- DP</div>
        <div class="muted">åˆçº¦: <span id="addrNFTPool"></span></div>
        <div class="group" style="margin-top:12px;">
          <label>å¿«é€Ÿè½¬å…¥ï¼ˆDPï¼‰</label>
          <input id="nftDepositAmount" placeholder="ä¾‹: 1000000" />
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn" onclick="depositToNFTPool()" style="flex:1">è½¬å…¥</button>
          <button class="btn secondary" onclick="refreshPoolBalances()" style="flex:1">åˆ·æ–°</button>
        </div>
        <div class="msg" id="msgNFTPool"></div>
      </div>
      <div class="card" style="background:#1e293b;">
        <h2 style="color:#a78bfa;">â›ï¸ T-Engine æ± ä½™é¢</h2>
        <div style="font-size:28px; font-weight:700; color:#c4b5fd; margin:16px 0;" id="tenPoolBalance">-- DP</div>
        <div class="muted">åˆçº¦: <span id="addrTEngineAddr"></span></div>
        <div class="group" style="margin-top:12px;">
          <label>å¿«é€Ÿè½¬å…¥ï¼ˆDPï¼‰</label>
          <input id="tenDepositAmount" placeholder="ä¾‹: 1000000" />
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn" onclick="depositToTEngine()" style="flex:1">è½¬å…¥</button>
          <button class="btn secondary" onclick="refreshPoolBalances()" style="flex:1">åˆ·æ–°</button>
        </div>
        <div class="msg" id="msgTEnginePool"></div>
      </div>
    </div>

    <!-- ç´§æ€¥æ§åˆ¶å¡ç‰‡ -->
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); margin-top:12px;">
      <!-- DPToken æ§åˆ¶ -->
      <div class="card" style="background:#1e293b; border:2px solid #ef4444;">
        <h2 style="color:#fca5a5;">ğŸª™ DPToken ç´§æ€¥æ§åˆ¶</h2>
        <div class="muted" style="margin-bottom:8px;">åˆçº¦: <span id="addrDPToken"></span></div>
        <div style="margin-bottom:10px;">
          <div class="stat"><span>ç‰ˆæœ¬</span><span id="dpVersion">--</span></div>
          <div class="stat"><span>çŠ¶æ€</span><span id="dpPaused" style="font-weight:700;">--</span></div>
          <div class="stat"><span>æ€»ä¾›åº”é‡</span><span id="dpTotalSupply">--</span></div>
          <div class="stat"><span>æœ€å¤§ä¾›åº”</span><span id="dpMaxSupply">--</span></div>
          <div class="stat"><span>ä¾›åº”æ¯”ä¾‹</span><span id="dpSupplyRatio">--</span></div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn danger" id="btnDPPause" style="flex:1">æš‚åœ DPToken</button>
          <button class="btn secondary" id="btnDPUnpause" style="flex:1">æ¢å¤ DPToken</button>
        </div>
        <div class="msg" id="msgDPToken"></div>
      </div>

      <!-- DebearPass æ§åˆ¶ -->
      <div class="card" style="background:#1e293b; border:2px solid #f59e0b;">
        <h2 style="color:#fbbf24;">ğŸ« DebearPass ç´§æ€¥æ§åˆ¶</h2>
        <div class="muted" style="margin-bottom:8px;">åˆçº¦: <span id="addrDebearPass"></span></div>
        <div style="margin-bottom:10px;">
          <div class="stat"><span>ç‰ˆæœ¬</span><span id="passVersion">--</span></div>
          <div class="stat"><span>çŠ¶æ€</span><span id="passPaused" style="font-weight:700;">--</span></div>
          <div class="stat"><span>Standard Pass</span><span id="passStandard">--</span></div>
          <div class="stat"><span>Premium Pass</span><span id="passPremium">--</span></div>
          <div class="stat"><span>Exclusive Pass</span><span id="passExclusive">--</span></div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn warning" id="btnPassPause" style="flex:1">æš‚åœ Pass</button>
          <button class="btn secondary" id="btnPassUnpause" style="flex:1">æ¢å¤ Pass</button>
        </div>
        <div class="msg" id="msgDebearPass"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Pass é”€å”®æ§åˆ¶ -->
      <div class="card">
        <h2>ğŸ« Pass é”€å”®</h2>
        <div class="muted" style="margin-bottom:8px;">åˆçº¦: <span id="addrPassSale"></span></div>
        
        <!-- ğŸ’¡ å»ºè®®ä»·æ ¼ -->
        <div style="background:#1e293b; border:1px solid #374151; border-radius:8px; padding:10px; margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <span style="font-size:13px; color:#9ca3af;">ğŸ’¡ å»ºè®®ä»·æ ¼ï¼ˆåŸºäº BERA å®æ—¶ä»·æ ¼ï¼‰</span>
            <button class="btn" id="btnRefreshBeraPrice" style="padding:4px 10px; font-size:12px;">ğŸ”„ åˆ·æ–°</button>
          </div>
          <div id="beraPrice" style="font-size:12px; color:#fbbf24; margin-bottom:6px;">åŠ è½½ä¸­...</div>
          <div style="display:flex; gap:8px; font-size:12px;">
            <div style="flex:1; text-align:center;">
              <div style="color:#9ca3af;">Standard ($800)</div>
              <div id="suggestStd" style="color:#86efac; font-weight:600;">--</div>
            </div>
            <div style="flex:1; text-align:center;">
              <div style="color:#9ca3af;">Premium ($3000)</div>
              <div id="suggestPre" style="color:#86efac; font-weight:600;">--</div>
            </div>
            <div style="flex:1; text-align:center;">
              <div style="color:#9ca3af;">Exclusive ($6600)</div>
              <div id="suggestEx" style="color:#86efac; font-weight:600;">--</div>
            </div>
          </div>
        </div>
        
        <div class="group">
          <label>ä»·æ ¼ï¼ˆBERAï¼‰</label>
          <div class="row">
            <input id="priceStd" placeholder="Standard ä¾‹: 0.10" style="flex:1" />
            <input id="pricePre" placeholder="Premium ä¾‹: 0.30" style="flex:1" />
            <input id="priceEx" placeholder="Exclusive ä¾‹: 0.50" style="flex:1" />
          </div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn" id="btnSetPrices">è®¾ç½®ä»·æ ¼</button>
          <div class="switch">
            <input type="checkbox" id="saleActiveSwitch" />
            <label for="saleActiveSwitch">é”€å”®å¼€å…³</label>
          </div>
        </div>
        <div class="msg" id="msgPassSale"></div>
        <div style="margin-top:10px;">
          <div class="stat"><span>å½“å‰ä»·æ ¼</span><span id="currPrices">--</span></div>
          <div class="stat"><span>é”€å”®çŠ¶æ€</span><span id="currSaleActive">--</span></div>
          <div class="stat"><span>æ€»é”€å”®é¢</span><span id="currTotalSales">--</span></div>
          <div class="stat"><span>å·²å”®æ•°é‡</span><span id="currSoldCount">--</span></div>
        </div>
      </div>

      <!-- NFT æŒ–çŸ¿æ§åˆ¶ -->
      <div class="card">
        <h2>ğŸ¨ NFT æŒ–çŸ¿</h2>
        <div class="muted" style="margin-bottom:8px;">åˆçº¦: <span id="addrNFTMining"></span></div>
        <div class="group">
          <label>åŸºç¡€æ—¥äº§å‡ºï¼ˆDP/å¤©ï¼‰</label>
          <input id="baseDailyReward" placeholder="ä¾‹: 80 (å°†æŒ‰ 18 ä½ç²¾åº¦è½¬æ¢)" />
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn" id="btnSetBase">è®¾ç½®æ—¥äº§å‡º</button>
          <div class="switch">
            <input type="checkbox" id="miningPausedSwitch" />
            <label for="miningPausedSwitch">æš‚åœé¢†å–</label>
          </div>
        </div>
        <div class="group" style="margin-top:8px;">
          <label>Claim ç¨è´¹ï¼ˆç™¾åˆ†æ¯” 0-100ï¼‰ä¸æ¥æ”¶åœ°å€</label>
          <div class="row">
            <input id="nftTaxRate" placeholder="ç¨ç‡ % (ä¾‹: 10)" style="flex:1" />
            <input id="nftTaxRecipient" placeholder="æ¥æ”¶åœ°å€ 0x..." style="flex:2" />
          </div>
        </div>
        <button class="btn secondary" id="btnSetNftTax">è®¾ç½®ç¨è´¹</button>
        <div class="msg" id="msgNFT"></div>
        <div style="margin-top:10px;">
          <div class="stat"><span>å½“å‰æ—¥äº§å‡º</span><span id="currBaseDaily">--</span></div>
          <div class="stat"><span>æš‚åœçŠ¶æ€</span><span id="currMiningPaused">--</span></div>
          <div class="stat"><span>ç¨è´¹</span><span id="currNftTax">--</span></div>
          <div class="stat"><span>ç´¯è®¡é¢†å–</span><span id="currNftClaimed">--</span></div>
        </div>
      </div>

      <!-- T-Engine æ§åˆ¶ -->
      <div class="card">
        <h2>â›ï¸ T-Engine</h2>
        <div class="muted" style="margin-bottom:8px;">åˆçº¦: <span id="addrTEngine"></span></div>
        <div class="group">
          <label>ä»½é¢å€æ•°ï¼ˆå¦‚ 4 è¡¨ç¤º 4xï¼‰</label>
          <input id="sharesMultiplier" placeholder="ä¾‹: 4" />
        </div>
        <div class="group">
          <label>æ¯æ—¥é‡Šæ”¾ç‡ï¼ˆä¸‡åˆ†æ¯”ï¼Œ0-10000ï¼›30=0.3%/å¤©ï¼‰</label>
          <input id="dailyReleaseRate" placeholder="ä¾‹: 30" />
        </div>
        <div class="group">
          <label>é‡Šæ”¾å‘¨æœŸæ—¶é•¿ï¼ˆç§’ï¼‰âš¡ æµ‹è¯•ç”¨</label>
          <div class="row">
            <input id="epochDuration" placeholder="86400=24å°æ—¶, 3600=1å°æ—¶" style="flex:1" />
            <button class="btn warning" id="btnSetEpochDuration" style="flex:0 0 auto;">è®¾ç½®å‘¨æœŸ</button>
          </div>
          <div class="muted" style="margin-top:4px;">âš ï¸ æµ‹è¯•æœŸè®¾ä¸º3600(1å°æ—¶)ï¼Œæ­£å¼è¿è¡Œè®¾ä¸º86400(24å°æ—¶)</div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn" id="btnSetMultiplier">è®¾ç½®å€æ•°</button>
          <button class="btn" id="btnSetDailyRate">è®¾ç½®æ¯æ—¥é‡Šæ”¾</button>
          <button class="btn warning" id="btnForceRelease">ğŸš€ æå‰é‡Šæ”¾ä¸€å¤©é‡</button>
          <div class="switch">
            <input type="checkbox" id="claimPausedSwitch" />
            <label for="claimPausedSwitch">æš‚åœé¢†å–</label>
          </div>
        </div>
        <div class="group" style="margin-top:8px;">
          <label>Claim ç¨è´¹ï¼ˆç™¾åˆ†æ¯” 0-100ï¼‰ä¸æ¥æ”¶åœ°å€</label>
          <div class="row">
            <input id="tenTaxRate" placeholder="ç¨ç‡ % (ä¾‹: 10)" style="flex:1" />
            <input id="tenTaxRecipient" placeholder="æ¥æ”¶åœ°å€ 0x..." style="flex:2" />
          </div>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn secondary" id="btnSetTenTaxRate">è®¾ç½®ç¨ç‡</button>
          <button class="btn secondary" id="btnSetTenTaxRecipient">è®¾ç½®æ¥æ”¶åœ°å€</button>
        </div>
        <div class="msg" id="msgTEngine"></div>
        <div style="margin-top:10px;">
          <div class="stat"><span>å½“å‰å€æ•°</span><span id="currMultiplier">--</span></div>
          <div class="stat"><span>å½“å‰æ¯æ—¥é‡Šæ”¾</span><span id="currDailyRate">--</span></div>
          <div class="stat"><span>é‡Šæ”¾å‘¨æœŸæ—¶é•¿</span><span id="currEpochDuration">--</span></div>
          <div class="stat"><span>å½“å‰Epoch</span><span id="currEpoch">--</span></div>
          <div class="stat"><span>æš‚åœçŠ¶æ€</span><span id="currClaimPaused">--</span></div>
          <div class="stat"><span>ç¨è´¹</span><span id="currTenTax">--</span></div>
          <div class="stat"><span>çŸ¿æ± ä½™é¢</span><span id="currTenPoolBal">--</span></div>
          <div class="stat"><span>ç´¯è®¡é”€æ¯</span><span id="currTenDeposited">--</span></div>
          <div class="stat"><span>ç´¯è®¡é¢†å–</span><span id="currTenClaimed">--</span></div>
          <div class="stat" style="border-top:2px solid #f59e0b; padding-top:8px; margin-top:8px;">
            <span>ğŸš€ å…¨å±€å¼ºåˆ¶é‡Šæ”¾è®¡æ•°å™¨ (V5)</span>
            <span id="currGlobalForceCounter" style="font-weight:700; color:#fbbf24;">--</span>
          </div>
        </div>
      </div>
      
      <!-- V5 å…¨å±€å¼ºåˆ¶é‡Šæ”¾æ§åˆ¶é¢æ¿ -->
      <div class="card" style="background:#1e293b; border:2px solid #f59e0b;">
        <h2 style="color:#fbbf24;">ğŸš€ V5 å…¨å±€å¼ºåˆ¶é‡Šæ”¾æ§åˆ¶</h2>
        <div class="muted" style="margin-bottom:12px;">
          â­ æ¯æ¬¡å¼ºåˆ¶é‡Šæ”¾ä¼šå¢åŠ å…¨å±€è®¡æ•°å™¨ï¼Œæ‰€æœ‰ç”¨æˆ·åŒæ­¥å¢åŠ  0.3% é€’å‡é‡Šæ”¾é‡ã€‚<br>
          ğŸš¨ æ³¨æ„ï¼šå¼ºåˆ¶é‡Šæ”¾ä¼šç«‹å³è§¦å‘ï¼Œæ— æ³•æ’¤é”€ï¼
        </div>
        
        <div class="group">
          <label>å•æ¬¡å¼ºåˆ¶é‡Šæ”¾ï¼ˆå…¨å±€è®¡æ•°å™¨ +1ï¼‰</label>
          <button class="btn warning" id="btnTriggerGlobalRelease" style="width:100%;">
            ğŸš€ è§¦å‘å•æ¬¡å¼ºåˆ¶é‡Šæ”¾
          </button>
        </div>
        
        <div class="group" style="margin-top:12px;">
          <label>æ‰¹é‡å¼ºåˆ¶é‡Šæ”¾ï¼ˆå…¨å±€è®¡æ•°å™¨ +Nï¼‰</label>
          <div class="row">
            <input id="multipleReleaseCount" placeholder="ä¾‹: 5 ï¼ˆèŒƒå›´ 1-100ï¼‰" style="flex:1" />
            <button class="btn warning" id="btnTriggerGlobalReleaseMultiple" style="flex:0 0 auto;">
              ğŸš€ æ‰¹é‡é‡Šæ”¾
            </button>
          </div>
          <div class="muted" style="margin-top:4px;">
            â— 5 æ¬¡ = 5Ã—0.3% é€’å‡é‡Šæ”¾ï¼Œå…¨å±€è®¡æ•°å™¨ +5
          </div>
        </div>
        
        <div class="group" style="margin-top:12px;">
          <label>ğŸ”„ é‡ç½®å…¨å±€è®¡æ•°å™¨ï¼ˆä¿®å¤æ–°ç”¨æˆ· bugï¼‰</label>
          <div class="row">
            <input id="resetCounterValue" placeholder="è¾“å…¥ 0 æ¸…é›¶è®¡æ•°å™¨" style="flex:1" />
            <button class="btn danger" id="btnResetForceReleaseCounters" style="flex:0 0 auto;">
              âš ï¸ é‡ç½®è®¡æ•°å™¨
            </button>
          </div>
          <div class="muted" style="margin-top:4px;">
            ğŸ’¡ é‡ç½®ä¸º 0ï¼šæ–°ç”¨æˆ·ä¸èƒ½é¢†å–å†å²å¼ºåˆ¶é‡Šæ”¾ï¼ˆä¿®å¤ bugï¼‰<br>
            âš ï¸ å·² claim çš„è€ç”¨æˆ·ä¸å—å½±å“ï¼Œæœª claim çš„ä¼šå¤±å»å¾…é¢†å–çš„å†å²é‡Šæ”¾
          </div>
        </div>
        
        <div class="msg" id="msgV5ForceRelease"></div>
      </div>
    </div>

    <div class="card" style="margin-bottom:24px; margin-top:16px;">
      <div class="muted">æç¤ºï¼šä»…åˆçº¦ Owner å¯è°ƒç”¨ä»¥ä¸Šç®¡ç†æ“ä½œã€‚è¯·ç¡®ä¿å½“å‰é’±åŒ…æ˜¯å„åˆçº¦çš„ ownerã€‚</div>
      <div class="muted">é»˜è®¤åœ°å€å·²ä»éƒ¨ç½²è®°å½•å¡«å……ï¼Œè‹¥æœ‰å‡çº§æˆ–å˜æ›´ï¼Œè¯·åœ¨æºç å†… CONTRACTS å¸¸é‡ä¸­æ›´æ–°ã€‚</div>
    </div>
  </div>

  <script>
    // ä»£ç†åœ°å€ï¼ˆå®é™…ä½¿ç”¨çš„åœ°å€ï¼Œå·²å‡çº§åˆ° v1.1.0ï¼‰
    const CONTRACTS = {
      passSale: '0x40477c0B232cF7AaF939EC79d2Cad51669E101C6',      // æ—§éƒ¨ç½²
      debearPass: '0x29f2a6756E5B79C36Eb6699220CB56f7749C7514',    // æ—§éƒ¨ç½²
      nftMining: '0x8883Ef27fFa001fAcc323E566Bce387A63Af5B4A',     // æ—§éƒ¨ç½²
      nftMiningPool: '0x0D9bfaC27128EA2754179400eB932F13B7c52097', // æ—§éƒ¨ç½²
      tEngine:   '0xd9661D56659B80A875E42A51955434A0818581D8',     // æ—§éƒ¨ç½²
      dpToken:   '0xf7C464c7832e59855aa245Ecc7677f54B3460e7d'      // âœ… å·²å‡çº§ v1.1.0
    };

    // ABIsï¼ˆä»…ç®¡ç†æ‰€éœ€ï¼‰
    const OWNABLE_ABI = [ 'function owner() view returns (address)' ];
    const ERC20_ABI = [
      'function balanceOf(address) view returns (uint256)',
      'function transfer(address to, uint256 amount) returns (bool)'
    ];

    const PASS_SALE_ABI = [
      'function setPrices(uint256[3])',
      'function getAllPrices() view returns (uint256[3])',
      'function setSaleActive(bool)',
      'function saleActive() view returns (bool)',
      'function totalSales() view returns (uint256)',
      'function totalSoldCount() view returns (uint256)',
      'function totalInviteRewards() view returns (uint256)',
      'function owner() view returns (address)'
    ];

    const NFT_MINING_ABI = [
      'function setBaseDailyReward(uint256)',
      'function baseDailyReward() view returns (uint256)',
      'function setMiningPaused(bool)',
      'function miningPaused() view returns (bool)',
      'function setTaxConfig(uint256,address)',
      'function taxRate() view returns (uint256)',
      'function taxRecipient() view returns (address)',
      // âŒ V3 æ”¹ä¸ºéœ€è¦å‚æ•°: 'function totalClaimed(address) view returns (uint256)',
      'function owner() view returns (address)'
    ];

    const TENGINE_ABI = [
      'function setSharesMultiplier(uint256)',
      'function sharesMultiplier() view returns (uint256)',
      'function setDailyReleaseRate(uint256)',
      'function dailyReleaseRate() view returns (uint256)',
      'function setClaimPaused(bool)',
      'function claimPaused() view returns (bool)',
      'function setTaxRate(uint256)',
      'function taxRate() view returns (uint256)',
      'function setTaxRecipient(address)',
      'function taxRecipient() view returns (address)',
      'function totalDeposited() view returns (uint256)',
      'function totalClaimed() view returns (uint256)',
      'function totalTaxCollected() view returns (uint256)',
      'function totalInviteRewards() view returns (uint256)',
      // 'function getPoolBalance() view returns (uint256)', // âŒ è¯¥æ–¹æ³•ä¸å­˜åœ¨äºå½“å‰åˆçº¦ç‰ˆæœ¬
      'function setEpochDuration(uint256)',
      'function epochDuration() view returns (uint256)',
      'function forceReleaseOneEpoch()',
      'function getCurrentEpoch() view returns (uint256)',
      // V2.5 æ–°å¢å‡½æ•°
      'function getCurrentDay() view returns (uint256)',
      'function releaseDayDuration() view returns (uint256)',
      'function manualDayOffset() view returns (uint256)',
      'function manualEpochOffset() view returns (uint256)',
      'function forceReleaseDays(uint256)',
      'function setReleaseDayDuration(uint256)',
      'function resetToProductionMode()',
      // V5 æ–°å¢ï¼šå…¨å±€å¼ºåˆ¶é‡Šæ”¾åŠŸèƒ½
      'function triggerGlobalRelease()',
      'function triggerGlobalReleaseMultiple(uint256 count)',
      'function resetForceReleaseCounters(uint256 newCount)',
      'function globalForceReleaseCount() view returns (uint256)',
      'function owner() view returns (address)'
    ];

    const DPTOKEN_ABI = [
      'function pause(string reason)',
      'function unpause()',
      'function paused() view returns (bool)',
      'function totalSupply() view returns (uint256)',
      'function MAX_SUPPLY() view returns (uint256)',
      'function checkSupplyAnomaly() view returns (bool isAnomalous, uint256 currentSupply, uint256 maxSupply)',
      'function version() view returns (string)',
      'function emergencyPauser() view returns (address)',
      'function owner() view returns (address)'
    ];

    const DEBEARPASS_ABI = [
      'function pause()',
      'function unpause()',
      'function paused() view returns (bool)',
      'function passConfigs(uint256) view returns (uint256 maxSupply, uint256 totalMinted, uint256 multiplier, uint256 inviteRate)',
      'function getRemainingSupply(uint256) view returns (uint256)',
      'function version() view returns (string)',
      'function owner() view returns (address)',
      'function balanceOf(address owner, uint256 id) view returns (uint256)'
    ];
    
    // ç¨è´¹æ¥æ”¶åœ°å€ï¼ˆç”¨äºæŸ¥è¯¢ Pass ä½™é¢ï¼‰
    const TAX_RECIPIENT = '0xd8b4286c2f299220830f7228bab15225b4ea8379';

    let provider, signer, user;
    let cachedBeraPrice = null;
    let lastPriceFetchTime = 0;

    // UI helpers
    const $ = (id) => document.getElementById(id);
    const setMsg = (id, text, ok=true) => { $(id).textContent = text; $(id).style.color = ok ? '#86efac' : '#fca5a5'; };
    
    // ğŸ’¡ è·å– BERA ä»·æ ¼ï¼ˆä½¿ç”¨å¤šä¸ª API å¤‡ç”¨ï¼‰
    async function fetchBeraPrice() {
      try {
        // ç¼“å­˜ 5 åˆ†é’Ÿ
        const now = Date.now();
        if (cachedBeraPrice && (now - lastPriceFetchTime) < 300000) {
          console.log('ğŸ’¾ ä½¿ç”¨ç¼“å­˜çš„ BERA ä»·æ ¼:', cachedBeraPrice);
          return cachedBeraPrice;
        }
        
        console.log('ğŸ”„ è·å– BERA ä»·æ ¼...');
        $('beraPrice').textContent = 'ğŸ”„ è·å–ä»·æ ¼ä¸­...';
        
        // å°è¯•å¤šä¸ª API
        const apis = [
          // 1. CoinGecko ç›´æ¥è®¿é—®
          async () => {
            const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=berachain-bera&vs_currencies=usd');
            const data = await res.json();
            return data['berachain-bera']?.usd;
          },
          // 2. ä½¿ç”¨ CORS ä»£ç†
          async () => {
            const res = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://api.coingecko.com/api/v3/simple/price?ids=berachain-bera&vs_currencies=usd'));
            const data = await res.json();
            const priceData = JSON.parse(data.contents);
            return priceData['berachain-bera']?.usd;
          },
          // 3. å¤‡ç”¨ï¼šæ‰‹åŠ¨è¾“å…¥ä»·æ ¼
          async () => {
            throw new Error('æ‰€æœ‰ API å‡å¤±è´¥');
          }
        ];
        
        let price = null;
        let lastError = null;
        
        for (let i = 0; i < apis.length; i++) {
          try {
            console.log(`ğŸ”„ å°è¯• API ${i + 1}...`);
            price = await Promise.race([
              apis[i](),
              new Promise((_, reject) => setTimeout(() => reject(new Error('è¶…æ—¶')), 10000))
            ]);
            
            if (price && price > 0) {
              console.log(`âœ… API ${i + 1} æˆåŠŸ:`, price, 'USD');
              break;
            }
          } catch (error) {
            console.warn(`âŒ API ${i + 1} å¤±è´¥:`, error.message);
            lastError = error;
            continue;
          }
        }
        
        if (!price || price <= 0) {
          throw lastError || new Error('æœªèƒ½è·å– BERA ä»·æ ¼');
        }
        
        cachedBeraPrice = price;
        lastPriceFetchTime = now;
        console.log('âœ… BERA ä»·æ ¼:', price, 'USD');
        return price;
      } catch (error) {
        console.error('âŒ è·å– BERA ä»·æ ¼å¤±è´¥:', error);
        $('beraPrice').textContent = `âŒ è·å–å¤±è´¥: ${error.message}`;
        $('beraPrice').style.color = '#fca5a5';
        
        // æä¾›æ‰‹åŠ¨è¾“å…¥é€‰é¡¹
        const manualPrice = prompt('è‡ªåŠ¨è·å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ BERA å½“å‰ USD ä»·æ ¼ï¼ˆä¾‹: 1.5ï¼‰ï¼š');
        if (manualPrice && !isNaN(manualPrice) && parseFloat(manualPrice) > 0) {
          const price = parseFloat(manualPrice);
          cachedBeraPrice = price;
          lastPriceFetchTime = now;
          console.log('ğŸ‘¤ ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ä»·æ ¼:', price);
          return price;
        }
        
        return null;
      }
    }
    
    // ğŸ“Š è®¡ç®—å¹¶æ˜¾ç¤ºå»ºè®®ä»·æ ¼
    async function updateSuggestedPrices() {
      const beraPrice = await fetchBeraPrice();
      
      if (!beraPrice) {
        $('suggestStd').textContent = '--';
        $('suggestPre').textContent = '--';
        $('suggestEx').textContent = '--';
        return;
      }
      
      // æ˜¾ç¤º BERA å½“å‰ä»·æ ¼
      $('beraPrice').textContent = `BERA å½“å‰ä»·æ ¼: $${beraPrice.toFixed(4)} USD`;
      $('beraPrice').style.color = '#fbbf24';
      
      // è®¡ç®—å»ºè®®ä»·æ ¼
      const stdBera = (800 / beraPrice).toFixed(2);
      const preBera = (3000 / beraPrice).toFixed(2);
      const exBera = (6600 / beraPrice).toFixed(2);
      
      $('suggestStd').textContent = `${stdBera} BERA`;
      $('suggestPre').textContent = `${preBera} BERA`;
      $('suggestEx').textContent = `${exBera} BERA`;
      
      console.log('ğŸ’¡ å»ºè®®ä»·æ ¼:', { stdBera, preBera, exBera });
    }

    async function connectWallet() {
      try {
        console.log('ğŸ”µ å¼€å§‹è¿æ¥é’±åŒ…...');
        const walletProvider = window.okxwallet || window.ethereum;
        if (!walletProvider) { 
          console.error('âŒ æœªæ£€æµ‹åˆ°é’±åŒ…');
          alert('è¯·å®‰è£… MetaMask / OKX Wallet'); 
          return; 
        }
        console.log('âœ… æ£€æµ‹åˆ°é’±åŒ…:', walletProvider.isMetaMask ? 'MetaMask' : walletProvider.isOKExWallet ? 'OKX' : 'æœªçŸ¥');
        
        await walletProvider.request({ method: 'eth_requestAccounts' });
        console.log('âœ… é’±åŒ…æˆæƒæˆåŠŸ');
        
        provider = new ethers.providers.Web3Provider(walletProvider);
        signer = provider.getSigner();
        user = await signer.getAddress();
        console.log('âœ… ç”¨æˆ·åœ°å€:', user);
        
        // æ£€æŸ¥ç½‘ç»œ
        const network = await provider.getNetwork();
        console.log('ğŸŒ å½“å‰ç½‘ç»œ:', {
          chainId: network.chainId,
          name: network.name
        });
        
        if (network.chainId !== 80094) {
          console.warn('âš ï¸ ç½‘ç»œä¸åŒ¹é…! å½“å‰:', network.chainId, 'æœŸæœ›: 80094');
          alert('è¯·åˆ‡æ¢åˆ° Berachain ä¸»ç½‘ (Chain ID: 80094)');
          return;
        }
        console.log('âœ… ç½‘ç»œæ£€æŸ¥é€šè¿‡');
        
        // æ£€æŸ¥ Gas ä»·æ ¼
        const feeData = await provider.getFeeData();
        console.log('â›½ Gas ä¿¡æ¯:', {
          gasPrice: feeData.gasPrice ? ethers.utils.formatUnits(feeData.gasPrice, 'gwei') + ' Gwei' : 'N/A',
          maxFeePerGas: feeData.maxFeePerGas ? ethers.utils.formatUnits(feeData.maxFeePerGas, 'gwei') + ' Gwei' : 'N/A'
        });
        $('connectBtn').textContent = 'å·²è¿æ¥';
        $('connectBtn').disabled = true;
        $('walletAddr').textContent = `${user.slice(0,6)}...${user.slice(-4)}`;
        $('addrPassSale').textContent = CONTRACTS.passSale;
        $('addrNFTMining').textContent = CONTRACTS.nftMining;
        $('addrTEngine').textContent  = CONTRACTS.tEngine;
        $('addrNFTPool').textContent = CONTRACTS.nftMiningPool;
        $('addrTEngineAddr').textContent = CONTRACTS.tEngine;
        $('addrDPToken').textContent = CONTRACTS.dpToken;
        $('addrDebearPass').textContent = CONTRACTS.debearPass || 'æœªé…ç½®';
        console.log('ğŸ”„ å¼€å§‹åˆ·æ–°æ•°æ®...');
        await refreshAll();
        await refreshPoolBalances();
        await updateSuggestedPrices();  // ğŸ’¡ åŠ è½½å»ºè®®ä»·æ ¼
        console.log('ğŸ‰ é’±åŒ…è¿æ¥å®Œæˆï¼');
      } catch (e) {
        console.error('âŒ è¿æ¥å¤±è´¥:', e);
        console.error('é”™è¯¯è¯¦æƒ…:', {
          message: e?.message,
          code: e?.code,
          stack: e?.stack
        });
        alert('è¿æ¥å¤±è´¥: ' + (e?.message||e));
      }
    }

    // æƒé™æ ‡è¯†
    async function refreshOwnerBadges() {
      try {
        const passSale = new ethers.Contract(CONTRACTS.passSale, PASS_SALE_ABI, provider);
        const nftM = new ethers.Contract(CONTRACTS.nftMining, NFT_MINING_ABI, provider);
        const ten = new ethers.Contract(CONTRACTS.tEngine, TENGINE_ABI, provider);
        const [o1, o2, o3] = await Promise.all([passSale.owner(), nftM.owner(), ten.owner()]);
        const isAllOwner = [o1,o2,o3].every(o => o.toLowerCase() === user.toLowerCase());
        $('ownerBadge').textContent = isAllOwner ? 'Owner å·²éªŒè¯' : 'å½“å‰éå…¨éƒ¨åˆçº¦ Owner';
        $('ownerBadge').style.color = isAllOwner ? '#bbf7d0' : '#fca5a5';
      } catch { $('ownerBadge').textContent = 'Owner æœªéªŒè¯'; }
    }

    // è¯»å–å½“å‰å€¼
    async function refreshAll() {
      await refreshOwnerBadges();
      await Promise.all([
        refreshDPToken(),
        refreshDebearPass(),
        refreshPassSale(),
        refreshNFTMining(),
        refreshTEngine(),
        refreshPoolBalances()
      ]);
    }

    // åˆ·æ–°çŸ¿æ± ä½™é¢
    async function refreshPoolBalances() {
      try {
        const dpToken = new ethers.Contract(CONTRACTS.dpToken, ERC20_ABI, provider);
        const [nftBal, tenBal] = await Promise.all([
          dpToken.balanceOf(CONTRACTS.nftMiningPool),
          dpToken.balanceOf(CONTRACTS.tEngine)
        ]);
        const fmt = (bn)=> parseFloat(ethers.utils.formatEther(bn)).toLocaleString('en-US', {maximumFractionDigits:2});
        $('nftPoolBalance').textContent = `${fmt(nftBal)} DP`;
        $('tenPoolBalance').textContent = `${fmt(tenBal)} DP`;
      } catch (e) {
        console.warn('è¯»å–çŸ¿æ± ä½™é¢å¤±è´¥:', e);
        $('nftPoolBalance').textContent = 'è¯»å–å¤±è´¥';
        $('tenPoolBalance').textContent = 'è¯»å–å¤±è´¥';
      }
    }

    async function refreshPassSale() {
      try {
        const passSale = new ethers.Contract(CONTRACTS.passSale, PASS_SALE_ABI, provider);
        const [prices, active, totalSales, soldCount] = await Promise.all([
          passSale.getAllPrices(),
          passSale.saleActive(),
          passSale.totalSales(),
          passSale.totalSoldCount()
        ]);
        const fmt = (v)=> parseFloat(ethers.utils.formatEther(v)).toFixed(3);
        $('currPrices').textContent = `Std ${fmt(prices[0])} / Pre ${fmt(prices[1])} / Ex ${fmt(prices[2])} BERA`;
        $('saleActiveSwitch').checked = !!active;
        $('currSaleActive').textContent = active ? 'å·²å¼€å¯' : 'å·²æš‚åœ';
        $('currTotalSales').textContent = `${fmt(totalSales)} BERA`;
        $('currSoldCount').textContent = soldCount.toString() + ' ä¸ª';
        // å¡«å……è¾“å…¥æ¡†ï¼ˆé¿å…è¦†ç›–ç”¨æˆ·æ‰‹å¡«ï¼šä»…ç©ºæ—¶å¡«ï¼‰
        if (!$('priceStd').value) $('priceStd').value = fmt(prices[0]);
        if (!$('pricePre').value) $('pricePre').value = fmt(prices[1]);
        if (!$('priceEx').value) $('priceEx').value = fmt(prices[2]);
      } catch (e) { setMsg('msgPassSale', 'è¯»å–å¤±è´¥: ' + (e?.message||e), false); }
    }

    async function refreshNFTMining() {
      try {
        const nftM = new ethers.Contract(CONTRACTS.nftMining, NFT_MINING_ABI, provider);
        
        // å°è¯•è¯»å– V2 æ–°å¢æ–¹æ³•
        let base, paused, rate, recip;
        try {
          [base, paused, rate, recip] = await Promise.all([
            nftM.baseDailyReward(),
            nftM.miningPaused(),
            nftM.taxRate(),
            nftM.taxRecipient()
            // âŒ V3 totalClaimed æ”¹ä¸ºéœ€è¦ address å‚æ•°,å·²ç§»é™¤
          ]);
        } catch (v2Error) {
          console.warn('NFTMining éƒ¨åˆ†æ–¹æ³•ä¸å­˜åœ¨ï¼Œå¯èƒ½æœªå®Œå…¨å‡çº§:', v2Error);
          throw new Error('åˆçº¦æ–¹æ³•è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åˆçº¦æ˜¯å¦å·²éƒ¨ç½²/å‡çº§');
        }
        
        const fmtBig = (bn)=> parseFloat(ethers.utils.formatEther(bn)).toLocaleString('en-US', {maximumFractionDigits:0});
        $('currBaseDaily').textContent = `${parseFloat(ethers.utils.formatEther(base)).toFixed(0)} DP/å¤©`;
        $('currMiningPaused').textContent = paused ? 'å·²æš‚åœ' : 'è¿è¡Œä¸­';
        $('miningPausedSwitch').checked = !!paused;
        // ä¿®å¤ï¼šæ£€æŸ¥ recip æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²æˆ–é›¶åœ°å€
        const validRecip = recip && recip !== '' && recip !== ethers.constants.AddressZero ? recip : 'æœªè®¾ç½®';
        $('currNftTax').textContent = `${rate.toString()}% / ${validRecip}`;
        $('currNftClaimed').textContent = 'V3 ä¸æ”¯æŒå…¨å±€ç»Ÿè®¡';
        if (!$('baseDailyReward').value) $('baseDailyReward').value = parseFloat(ethers.utils.formatEther(base)).toFixed(0);
        if (!$('nftTaxRate').value) $('nftTaxRate').value = rate.toString();
        if (!$('nftTaxRecipient').value && recip && recip !== '' && recip !== ethers.constants.AddressZero) $('nftTaxRecipient').value = recip;
      } catch (e) { setMsg('msgNFT', 'è¯»å–å¤±è´¥: ' + (e?.message||e), false); }
    }

    async function refreshTEngine() {
      try {
        const ten = new ethers.Contract(CONTRACTS.tEngine, TENGINE_ABI, provider);
        
        // V2.5: ä¼˜å…ˆå°è¯•è¯»å–æ–°çš„ releaseDayDuration å’Œ getCurrentDay
        let epochDuration, currentEpoch, isV25 = false;
        try {
          const [duration, day, offset] = await Promise.all([
            ten.releaseDayDuration().catch(() => null),
            ten.getCurrentDay().catch(() => null),
            ten.manualDayOffset().catch(() => null)
          ]);
          
          if (duration !== null && day !== null) {
            // V2.5 æ–¹æ³•å¯ç”¨
            epochDuration = duration;
            currentEpoch = day;
            isV25 = true;
            console.log('\u2705 T-Engine V2.5 æ£€æµ‹åˆ°:', { day: day.toString(), duration: duration.toString(), offset: offset?.toString() });
          } else {
            // fallback åˆ°æ—§æ–¹æ³•
            [epochDuration, currentEpoch] = await Promise.all([
              ten.epochDuration(),
              ten.getCurrentEpoch()
            ]);
          }
        } catch (newMethodError) {
          console.warn('T-Engine æœªå‡çº§ï¼ŒepochDuration/getCurrentEpoch ä¸å¯ç”¨:', newMethodError);
          epochDuration = null;
          currentEpoch = null;
        }
        
        // æ‰€æœ‰æ–¹æ³•éƒ½åº”è¯¥åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­å­˜åœ¨
        const [mul, daily, paused, rate, recip, deposited, claimed] = await Promise.all([
          ten.sharesMultiplier(),
          ten.dailyReleaseRate(),
          ten.claimPaused(),
          ten.taxRate(),
          ten.taxRecipient(),
          ten.totalDeposited(),
          ten.totalClaimed()
        ]);
        
        // ä» DP Token åˆçº¦è¯»å– T-Engine æ± ä½™é¢ï¼ˆgetPoolBalance æ–¹æ³•ä¸å­˜åœ¨äºå½“å‰ç‰ˆæœ¬ï¼‰
        const dpToken = new ethers.Contract(CONTRACTS.dpToken, ERC20_ABI, provider);
        const poolBal = await dpToken.balanceOf(CONTRACTS.tEngine);
        
        const fmtBig = (bn)=> parseFloat(ethers.utils.formatEther(bn)).toLocaleString('en-US', {maximumFractionDigits:0});
        $('currMultiplier').textContent = mul.toString() + 'x';
        $('currDailyRate').textContent = `${daily.toString()} (ä¸‡åˆ†æ¯”)`;
        
        // æ˜¾ç¤º epochDuration
        if (epochDuration !== null) {
          const hours = parseFloat(epochDuration.toString()) / 3600;
          $('currEpochDuration').textContent = `${epochDuration.toString()}ç§’ (${hours.toFixed(1)}å°æ—¶)`;
          if (!$('epochDuration').value) $('epochDuration').value = epochDuration.toString();
        } else {
          $('currEpochDuration').textContent = 'éœ€å‡çº§';
        }
        
        // æ˜¾ç¤ºå½“å‰ Epoch/Day
        if (currentEpoch !== null) {
          $('currEpoch').textContent = currentEpoch.toString() + (isV25 ? ' (UTC Day)' : '');
        } else {
          $('currEpoch').textContent = 'éœ€å‡çº§';
        }
        
        $('currClaimPaused').textContent = paused ? 'å·²æš‚åœ' : 'è¿è¡Œä¸­';
        $('claimPausedSwitch').checked = !!paused;
        $('currTenTax').textContent = `${rate.toString()}% / ${recip}`;
        $('currTenPoolBal').textContent = `${fmtBig(poolBal)} DP`;
        $('currTenDeposited').textContent = `${fmtBig(deposited)} DP`;
        $('currTenClaimed').textContent = `${fmtBig(claimed)} DP`;
        if (!$('sharesMultiplier').value) $('sharesMultiplier').value = mul.toString();
        if (!$('dailyReleaseRate').value) $('dailyReleaseRate').value = daily.toString();
        if (!$('tenTaxRate').value) $('tenTaxRate').value = rate.toString();
        if (!$('tenTaxRecipient').value) $('tenTaxRecipient').value = recip;
        
        // V5: è¯»å–å…¨å±€å¼ºåˆ¶é‡Šæ”¾è®¡æ•°å™¨
        try {
          const globalCounter = await ten.globalForceReleaseCount();
          $('currGlobalForceCounter').textContent = globalCounter.toString();
          $('currGlobalForceCounter').style.color = '#fbbf24';
          console.log('âœ… V5 å…¨å±€å¼ºåˆ¶é‡Šæ”¾è®¡æ•°å™¨:', globalCounter.toString());
        } catch (v5Error) {
          console.warn('V5 globalForceReleaseCounter ä¸å¯ç”¨ï¼Œæœªå‡çº§åˆ° V5:', v5Error);
          $('currGlobalForceCounter').textContent = 'éœ€å‡çº§ V5';
          $('currGlobalForceCounter').style.color = '#9ca3af';
        }
      } catch (e) { 
        console.warn('TEngine è¯»å–å¤±è´¥:', e);
        setMsg('msgTEngine', 'è¯»å–å¤±è´¥: ' + (e?.message||e), false); 
      }
    }

    // å†™æ“ä½œ
    async function withSigner(addr, abi) {
      if (!signer) throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
      return new ethers.Contract(addr, abi, signer);
    }

    // PassSale
    $('btnSetPrices').onclick = async () => {
      try {
        console.log('ğŸ”µ å¼€å§‹è®¾ç½® Pass ä»·æ ¼...');
        setMsg('msgPassSale', 'å‡†å¤‡ä¸­...');
        
        const passSale = await withSigner(CONTRACTS.passSale, PASS_SALE_ABI);
        console.log('âœ… PassSale åˆçº¦å®ä¾‹åˆ›å»ºæˆåŠŸ:', CONTRACTS.passSale);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰ signer
        const signerAddr = await signer.getAddress();
        console.log('ğŸ”‘ Signer åœ°å€:', signerAddr);
        
        const p1 = ethers.utils.parseEther(($('priceStd').value || '0').trim());
        const p2 = ethers.utils.parseEther(($('pricePre').value || '0').trim());
        const p3 = ethers.utils.parseEther(($('priceEx').value || '0').trim());
        
        console.log('ğŸ“Š å‡†å¤‡è®¾ç½®ä»·æ ¼:', {
          standard: ethers.utils.formatEther(p1) + ' BERA',
          premium: ethers.utils.formatEther(p2) + ' BERA',
          exclusive: ethers.utils.formatEther(p3) + ' BERA'
        });
        
        // å…ˆä¼°ç®— Gas
        console.log('â›½ ä¼°ç®— Gas...');
        try {
          const gasEstimate = await passSale.estimateGas.setPrices([p1, p2, p3]);
          console.log('âœ… Gas ä¼°ç®—:', gasEstimate.toString());
        } catch (gasError) {
          console.error('âŒ Gas ä¼°ç®—å¤±è´¥:', gasError);
          throw new Error('Gas ä¼°ç®—å¤±è´¥ï¼Œå¯èƒ½ä¸æ˜¯ Owner æˆ–åˆçº¦æ–¹æ³•ä¸å­˜åœ¨: ' + (gasError.reason || gasError.message));
        }
        
        console.log('ğŸ”„ è°ƒç”¨ setPrices å‡½æ•°...');
        setMsg('msgPassSale', 'ç­‰å¾…é’±åŒ…ç¡®è®¤...');
        
        // æ‰‹åŠ¨æ„å»ºäº¤æ˜“å‚æ•°
        const txOptions = {
          gasLimit: 50000  // æ‰‹åŠ¨è®¾ç½® Gas Limit
        };
        console.log('ğŸ“ äº¤æ˜“å‚æ•°:', txOptions);
        
        console.log('ğŸ’¡ å³å°†è°ƒç”¨ passSale.setPrices...');
        let txPromise;
        try {
          txPromise = passSale.setPrices([p1, p2, p3], txOptions);
          console.log('âœ… txPromise åˆ›å»ºæˆåŠŸ');
        } catch (callError) {
          console.error('âŒ è°ƒç”¨ setPrices å¤±è´¥:', callError);
          throw callError;
        }
        
        const tx = await Promise.race([
          txPromise,
          new Promise((_, reject) => setTimeout(() => reject(new Error('äº¤æ˜“è¶…æ—¶ï¼ˆ60ç§’ï¼‰ï¼Œè¯·æ£€æŸ¥é’±åŒ…æ˜¯å¦å¼¹å‡ºç¡®è®¤çª—å£')), 60000))
        ]);
        
        console.log('âœ… äº¤æ˜“å·²æäº¤:', tx.hash);
        setMsg('msgPassSale', `äº¤æ˜“å·²æäº¤: ${tx.hash.slice(0,10)}...`);
        console.log('â³ ç­‰å¾…äº¤æ˜“ç¡®è®¤...');
        
        const receipt = await tx.wait();
        console.log('âœ… äº¤æ˜“å·²ç¡®è®¤:', receipt);
        
        setMsg('msgPassSale', 'âœ… ä»·æ ¼å·²æ›´æ–°');
        await refreshPassSale();
        console.log('ğŸ‰ ä»·æ ¼æ›´æ–°å®Œæˆï¼');
      } catch (e) { 
        console.error('âŒ è®¾ç½®ä»·æ ¼å¤±è´¥:', e);
        console.error('é”™è¯¯è¯¦æƒ…:', {
          message: e?.message,
          code: e?.code,
          reason: e?.reason,
          data: e?.data,
          transaction: e?.transaction
        });
        
        let errorMsg = e?.message || String(e);
        if (e?.code === 4001) errorMsg = 'ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“';
        if (e?.code === -32603) errorMsg = 'äº¤æ˜“æ‰§è¡Œå¤±è´¥: ' + (e?.data?.message || e?.reason || 'æœªçŸ¥é”™è¯¯');
        if (e?.code === 'UNPREDICTABLE_GAS_LIMIT') errorMsg = 'Gas ä¼°ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æœ‰ Owner æƒé™';
        
        setMsg('msgPassSale', 'âŒ ' + errorMsg, false); 
      }
    };

    $('saleActiveSwitch').onchange = async (e) => {
      const targetState = e.target.checked;
      try {
        console.log('ğŸ”µ æ›´æ”¹é”€å”®çŠ¶æ€:', targetState ? 'å¼€å¯' : 'å…³é—­');
        setMsg('msgPassSale', 'å‡†å¤‡ä¸­...');
        
        const passSale = await withSigner(CONTRACTS.passSale, PASS_SALE_ABI);
        console.log('âœ… PassSale åˆçº¦å®ä¾‹åˆ›å»ºæˆåŠŸ');
        
        // å…ˆä¼°ç®— Gas
        console.log('â›½ ä¼°ç®— Gas...');
        try {
          const gasEstimate = await passSale.estimateGas.setSaleActive(targetState);
          console.log('âœ… Gas ä¼°ç®—:', gasEstimate.toString());
        } catch (gasError) {
          console.error('âŒ Gas ä¼°ç®—å¤±è´¥:', gasError);
          throw new Error('Gas ä¼°ç®—å¤±è´¥ï¼Œå¯èƒ½ä¸æ˜¯ Owner æˆ–åˆçº¦æ–¹æ³•ä¸å­˜åœ¨: ' + (gasError.reason || gasError.message));
        }
        
        console.log('ğŸ”„ è°ƒç”¨ setSaleActive å‡½æ•°...');
        setMsg('msgPassSale', 'ç­‰å¾…é’±åŒ…ç¡®è®¤...');
        
        // æ‰‹åŠ¨æ„å»ºäº¤æ˜“å‚æ•°
        const txOptions = {
          gasLimit: 50000
        };
        console.log('ğŸ“ äº¤æ˜“å‚æ•°:', txOptions);
        
        console.log('ğŸ’¡ å³å°†è°ƒç”¨ passSale.setSaleActive...');
        let txPromise;
        try {
          txPromise = passSale.setSaleActive(targetState, txOptions);
          console.log('âœ… txPromise åˆ›å»ºæˆåŠŸ');
        } catch (callError) {
          console.error('âŒ è°ƒç”¨ setSaleActive å¤±è´¥:', callError);
          throw callError;
        }
        
        const tx = await Promise.race([
          txPromise,
          new Promise((_, reject) => setTimeout(() => reject(new Error('äº¤æ˜“è¶…æ—¶ï¼ˆ60ç§’ï¼‰ï¼Œè¯·æ£€æŸ¥é’±åŒ…æ˜¯å¦å¼¹å‡ºç¡®è®¤çª—å£')), 60000))
        ]);
        
        console.log('âœ… äº¤æ˜“å·²æäº¤:', tx.hash);
        setMsg('msgPassSale', `äº¤æ˜“å·²æäº¤: ${tx.hash.slice(0,10)}...`);
        
        const receipt = await tx.wait();
        console.log('âœ… äº¤æ˜“å·²ç¡®è®¤:', receipt);
        
        setMsg('msgPassSale', 'âœ… é”€å”®çŠ¶æ€å·²æ›´æ–°');
        await refreshPassSale();
      } catch (e2) { 
        console.error('âŒ æ›´æ”¹é”€å”®çŠ¶æ€å¤±è´¥:', e2);
        console.error('é”™è¯¯è¯¦æƒ…:', {
          message: e2?.message,
          code: e2?.code,
          reason: e2?.reason,
          data: e2?.data
        });
        
        let errorMsg = e2?.message || String(e2);
        if (e2?.code === 4001) errorMsg = 'ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“';
        if (e2?.code === -32603) errorMsg = 'äº¤æ˜“æ‰§è¡Œå¤±è´¥: ' + (e2?.data?.message || e2?.reason || 'æœªçŸ¥é”™è¯¯');
        if (e2?.code === 'UNPREDICTABLE_GAS_LIMIT') errorMsg = 'Gas ä¼°ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æœ‰ Owner æƒé™';
        
        setMsg('msgPassSale', 'âŒ ' + errorMsg, false);
        // æ¢å¤å¼€å…³çŠ¶æ€
        e.target.checked = !targetState;
        await refreshPassSale(); 
      }
    };

    // NFT Mining
    $('btnSetBase').onclick = async () => {
      try {
        const nftM = await withSigner(CONTRACTS.nftMining, NFT_MINING_ABI);
        const v = $('baseDailyReward').value.trim();
        const wei = ethers.utils.parseEther(v || '0');
        
        // âœ… V4æç¤º: ä¿®æ”¹è´¹ç‡å‰ä¼šè‡ªåŠ¨ç»“ç®—æ‰€æœ‰ç”¨æˆ·
        if (!confirm(`ç¡®è®¤ä¿®æ”¹æ—¥äº§å‡ºä¸º ${v} DPï¼Ÿ\n\nâœ… V4ç‰¹æ€§ï¼š\n- ä¿®æ”¹å‰ä¼šè‡ªåŠ¨ç»“ç®—æ‰€æœ‰æ´»è·ƒç”¨æˆ·çš„å¾…é¢†å¥–åŠ±\n- å¥–åŠ±ç›´æ¥å‘æ”¾åˆ°ç”¨æˆ·é’±åŒ…\n- ç„¶åä¿®æ”¹è´¹ç‡\n\nâš ï¸ Gasæ¶ˆè€—å¯èƒ½è¾ƒé«˜ï¼Œå–å†³äºæ´»è·ƒç”¨æˆ·æ•°é‡ã€‚`)) {
          setMsg('msgNFT', 'å·²å–æ¶ˆæ“ä½œ');
          return;
        }
        
        setMsg('msgNFT', 'âš™ï¸ æ­£åœ¨ç»“ç®—æ‰€æœ‰ç”¨æˆ·...ï¼ˆè¯·ç­‰å¾…ï¼‰');
        const tx = await nftM.setBaseDailyReward(wei);
        setMsg('msgNFT', 'â³ æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgNFT', 'âœ… åŸºç¡€æ—¥äº§å‡ºå·²æ›´æ–°ï¼Œæ‰€æœ‰ç”¨æˆ·å·²è‡ªåŠ¨ç»“ç®—');
        await refreshNFTMining();
      } catch (e) { setMsg('msgNFT', e?.message||String(e), false); }
    };

    $('miningPausedSwitch').onchange = async (e) => {
      try {
        const nftM = await withSigner(CONTRACTS.nftMining, NFT_MINING_ABI);
        const tx = await nftM.setMiningPaused(e.target.checked);
        setMsg('msgNFT', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgNFT', 'æš‚åœçŠ¶æ€å·²æ›´æ–°');
        await refreshNFTMining();
      } catch (e2) { setMsg('msgNFT', e2?.message||String(e2), false); await refreshNFTMining(); }
    };

    $('btnSetNftTax').onclick = async () => {
      try {
        const rate = parseInt(($('nftTaxRate').value||'0').trim(), 10);
        const recip = ($('nftTaxRecipient').value||'').trim();
        const nftM = await withSigner(CONTRACTS.nftMining, NFT_MINING_ABI);
        const tx = await nftM.setTaxConfig(rate, recip);
        setMsg('msgNFT', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgNFT', 'ç¨è´¹é…ç½®å·²æ›´æ–°');
        await refreshNFTMining();
      } catch (e) { setMsg('msgNFT', e?.message||String(e), false); }
    };

    // TEngine
    $('btnSetMultiplier').onclick = async () => {
      try {
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const mul = parseInt(($('sharesMultiplier').value||'0').trim(), 10);
        const tx = await ten.setSharesMultiplier(mul);
        setMsg('msgTEngine', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgTEngine', 'å€æ•°å·²æ›´æ–°');
        await refreshTEngine();
      } catch (e) { setMsg('msgTEngine', e?.message||String(e), false); }
    };

    $('btnSetDailyRate').onclick = async () => {
      try {
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const rate = parseInt(($('dailyReleaseRate').value||'0').trim(), 10);
        const tx = await ten.setDailyReleaseRate(rate);
        setMsg('msgTEngine', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgTEngine', 'æ¯æ—¥é‡Šæ”¾ç‡å·²æ›´æ–°');
        await refreshTEngine();
      } catch (e) { setMsg('msgTEngine', e?.message||String(e), false); }
    };

    $('claimPausedSwitch').onchange = async (e) => {
      try {
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const tx = await ten.setClaimPaused(e.target.checked);
        setMsg('msgTEngine', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgTEngine', 'æš‚åœçŠ¶æ€å·²æ›´æ–°');
        await refreshTEngine();
      } catch (e2) { setMsg('msgTEngine', e2?.message||String(e2), false); await refreshTEngine(); }
    };

    $('btnSetTenTaxRate').onclick = async () => {
      try {
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const rate = parseInt(($('tenTaxRate').value||'0').trim(), 10);
        const tx = await ten.setTaxRate(rate);
        setMsg('msgTEngine', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgTEngine', 'ç¨ç‡å·²æ›´æ–°');
        await refreshTEngine();
      } catch (e) { setMsg('msgTEngine', e?.message||String(e), false); }
    };

    $('btnSetTenTaxRecipient').onclick = async () => {
      try {
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const recip = ($('tenTaxRecipient').value||'').trim();
        const tx = await ten.setTaxRecipient(recip);
        setMsg('msgTEngine', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgTEngine', 'ç¨è´¹æ¥æ”¶åœ°å€å·²æ›´æ–°');
        await refreshTEngine();
      } catch (e) { setMsg('msgTEngine', e?.message||String(e), false); }
    };

    // è®¾ç½®é‡Šæ”¾å‘¨æœŸæ—¶é•¿
    $('btnSetEpochDuration').onclick = async () => {
      try {
        const duration = parseInt(($('epochDuration').value||'0').trim(), 10);
        if (duration <= 0) { setMsg('msgTEngine', 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç§’æ•°', false); return; }
        if (duration > 86400) { setMsg('msgTEngine', 'âš ï¸ æ—¶é•¿ä¸èƒ½è¶…è¿‡24å°æ—¶(86400ç§’)', false); return; }
        
        const hours = (duration / 3600).toFixed(1);
        if (!confirm(`ç¡®å®šè®¾ç½®é‡Šæ”¾å‘¨æœŸä¸º ${duration} ç§’ (${hours} å°æ—¶) å—ï¼Ÿ\n\nâš ï¸ è¿™å°†å½±å“æ‰€æœ‰ç”¨æˆ·çš„é‡Šæ”¾èŠ‚å¥ï¼`)) return;
        
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const tx = await ten.setEpochDuration(duration);
        setMsg('msgTEngine', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgTEngine', `âœ… é‡Šæ”¾å‘¨æœŸå·²æ›´æ–°ä¸º ${duration} ç§’`);
        await refreshTEngine();
      } catch (e) { setMsg('msgTEngine', e?.message||String(e), false); }
    };

    // å¼ºåˆ¶æå‰é‡Šæ”¾ä¸€å¤©é‡
    $('btnForceRelease').onclick = async () => {
      if (!confirm('âš ï¸ ç¡®å®šè¦å¼ºåˆ¶è§¦å‘ä¸€æ¬¡é‡Šæ”¾å—ï¼Ÿ\n\nè¿™å°†ç«‹å³è®©æ‰€æœ‰ç”¨æˆ·å¯ä»¥é¢†å–ä¸‹ä¸€ä¸ªå‘¨æœŸçš„å¥–åŠ±ï¼\n\nå»ºè®®ä»…åœ¨æµ‹è¯•æœŸé—´ä½¿ç”¨ã€‚')) return;
      try {
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const tx = await ten.forceReleaseOneEpoch();
        setMsg('msgTEngine', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgTEngine', 'ğŸš€ å·²å¼ºåˆ¶é‡Šæ”¾ä¸€ä¸ªå‘¨æœŸï¼ç”¨æˆ·ç°åœ¨å¯ä»¥é¢†å–å¥–åŠ±');
        await refreshTEngine();
      } catch (e) { setMsg('msgTEngine', e?.message||String(e), false); }
    };

    // V5: å•æ¬¡å…¨å±€å¼ºåˆ¶é‡Šæ”¾
    $('btnTriggerGlobalRelease').onclick = async () => {
      if (!confirm('ğŸš€ ç¡®å®šè¦è§¦å‘å•æ¬¡å…¨å±€å¼ºåˆ¶é‡Šæ”¾å—ï¼Ÿ\n\nè¿™å°†ï¼š\nâ€¢ å…¨å±€è®¡æ•°å™¨ +1\nâ€¢ æ‰€æœ‰ç”¨æˆ·åŒæ­¥å¢åŠ  0.3% é€’å‡é‡Šæ”¾é‡\nâ€¢ ç«‹å³ç”Ÿæ•ˆï¼Œæ— æ³•æ’¤é”€ï¼')) return;
      try {
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const tx = await ten.triggerGlobalRelease();
        setMsg('msgV5ForceRelease', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgV5ForceRelease', 'âœ… å•æ¬¡å…¨å±€å¼ºåˆ¶é‡Šæ”¾å·²è§¦å‘ï¼è®¡æ•°å™¨ +1');
        await refreshTEngine();
      } catch (e) { setMsg('msgV5ForceRelease', e?.message||String(e), false); }
    };

    // V5: æ‰¹é‡å…¨å±€å¼ºåˆ¶é‡Šæ”¾
    $('btnTriggerGlobalReleaseMultiple').onclick = async () => {
      try {
        const count = parseInt(($('multipleReleaseCount').value||'0').trim(), 10);
        if (count < 1 || count > 100) { 
          setMsg('msgV5ForceRelease', 'è¯·è¾“å…¥ 1-100 ä¹‹é—´çš„æ•°å­—', false); 
          return; 
        }
        
        const releaseAmount = (count * 0.3).toFixed(1);
        if (!confirm(`ğŸš€ ç¡®å®šè¦æ‰¹é‡è§¦å‘ ${count} æ¬¡å…¨å±€å¼ºåˆ¶é‡Šæ”¾å—ï¼Ÿ\n\nè¿™å°†ï¼š\nâ€¢ å…¨å±€è®¡æ•°å™¨ +${count}\nâ€¢ æ‰€æœ‰ç”¨æˆ·åŒæ­¥å¢åŠ  ${releaseAmount}% é€’å‡é‡Šæ”¾é‡\nâ€¢ ç«‹å³ç”Ÿæ•ˆï¼Œæ— æ³•æ’¤é”€ï¼`)) return;
        
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const tx = await ten.triggerGlobalReleaseMultiple(count);
        setMsg('msgV5ForceRelease', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgV5ForceRelease', `âœ… æ‰¹é‡å…¨å±€å¼ºåˆ¶é‡Šæ”¾å·²è§¦å‘ï¼è®¡æ•°å™¨ +${count}`);
        await refreshTEngine();
      } catch (e) { setMsg('msgV5ForceRelease', e?.message||String(e), false); }
    };

    // V5: é‡ç½®å…¨å±€è®¡æ•°å™¨
    $('btnResetForceReleaseCounters').onclick = async () => {
      try {
        const newCount = parseInt(($('resetCounterValue').value||'0').trim(), 10);
        if (newCount < 0) { 
          setMsg('msgV5ForceRelease', 'è¯·è¾“å…¥æœ‰æ•ˆçš„éè´Ÿæ•´æ•°', false); 
          return; 
        }
        
        let confirmMsg = `âš ï¸ ç¡®å®šè¦é‡ç½®å…¨å±€è®¡æ•°å™¨ä¸º ${newCount} å—ï¼Ÿ\n\n`;
        
        if (newCount === 0) {
          confirmMsg += `ğŸ’¡ é‡ç½®ä¸º 0 çš„ä½œç”¨ï¼š\nâ€¢ ä¿®å¤æ–°ç”¨æˆ· bugï¼šæ–°ç”¨æˆ·ä¸èƒ½é¢†å–å†å²å¼ºåˆ¶é‡Šæ”¾\nâ€¢ å·² claim çš„è€ç”¨æˆ·ï¼šä¸å—å½±å“ï¼Œå·²é¢†å–çš„ä¸ä¼šè¢«æ’¤å›\nâ€¢ æœª claim çš„è€ç”¨æˆ·ï¼šä¼šå¤±å»å¾…é¢†å–çš„å†å²é‡Šæ”¾\n\nè¿™æ˜¯æ¨èçš„ä¿®å¤æ–¹æ¡ˆï¼`;
        } else {
          confirmMsg += `è¿™æ˜¯ä¸€ä¸ªé‡å¤§æ“ä½œï¼\n\nâ€¢ ä¼šç›´æ¥è®¾ç½®å…¨å±€è®¡æ•°å™¨ä¸º ${newCount}\nâ€¢ ä¼šå½±å“æ‰€æœ‰ç”¨æˆ·çš„é‡Šæ”¾é‡è®¡ç®—\nâ€¢ ä¸€èˆ¬ç”¨äºé‡æ–°è®¾ç½®åŸºå‡†å€¼\n\nè¯·ç¡®è®¤ä½ çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼`;
        }
        
        if (!confirm(confirmMsg)) return;
        
        const ten = await withSigner(CONTRACTS.tEngine, TENGINE_ABI);
        const tx = await ten.resetForceReleaseCounters(newCount);
        setMsg('msgV5ForceRelease', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgV5ForceRelease', `âœ… å…¨å±€è®¡æ•°å™¨å·²é‡ç½®ä¸º ${newCount}`);
        await refreshTEngine();
      } catch (e) { setMsg('msgV5ForceRelease', e?.message||String(e), false); }
    };

    // DPToken æ§åˆ¶
    async function refreshDPToken() {
      try {
        const dpToken = new ethers.Contract(CONTRACTS.dpToken, DPTOKEN_ABI, provider);
        
        // å°è¯•è¯»å– V2 æ–¹æ³•ï¼ˆpaused, versionï¼‰
        let paused, version;
        try {
          [paused, version] = await Promise.all([
            dpToken.paused(),
            dpToken.version()
          ]);
        } catch (v2Error) {
          // V2 æ–¹æ³•ä¸å­˜åœ¨ï¼Œè¯´æ˜æœªå‡çº§
          console.warn('DPToken æœªå‡çº§åˆ° V2ï¼Œæš‚åœåŠŸèƒ½ä¸å¯ç”¨');
          paused = null;
          version = 'V1 (æœªå‡çº§)';
        }
        
        // è¯»å–åŸºç¡€ä¿¡æ¯ï¼ˆV1 å·²æœ‰ï¼‰
        let totalSupply, maxSupply;
        try {
          totalSupply = await dpToken.totalSupply();
        } catch (supplyError) {
          console.warn('æ— æ³•è¯»å– totalSupplyï¼Œåˆçº¦å¯èƒ½æœªæ­£ç¡®éƒ¨ç½²');
          throw new Error('åˆçº¦åœ°å€æ— æ•ˆæˆ–æœªéƒ¨ç½²');
        }
        
        // MAX_SUPPLY å¯èƒ½ä¸å­˜åœ¨äºæŸäº›æ—§ç‰ˆæœ¬
        try {
          maxSupply = await dpToken.MAX_SUPPLY();
        } catch (maxSupplyError) {
          console.warn('MAX_SUPPLY ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼ 10 äº¿');
          maxSupply = ethers.utils.parseEther('1000000000'); // 10 äº¿ DP
        }
        
        const fmt = (bn) => parseFloat(ethers.utils.formatEther(bn)).toLocaleString('en-US', {maximumFractionDigits:0});
        $('dpVersion').textContent = version;
        
        if (paused !== null) {
          $('dpPaused').textContent = paused ? 'â›¸ï¸ å·²æš‚åœ' : 'âœ… è¿è¡Œä¸­';
          $('dpPaused').style.color = paused ? '#fca5a5' : '#86efac';
          $('btnDPPause').disabled = paused;
          $('btnDPUnpause').disabled = !paused;
        } else {
          $('dpPaused').textContent = 'ğŸ”„ éœ€å‡çº§åˆ° V2';
          $('dpPaused').style.color = '#fbbf24';
          $('btnDPPause').disabled = true;
          $('btnDPUnpause').disabled = true;
        }
        
        $('dpTotalSupply').textContent = `${fmt(totalSupply)} DP`;
        $('dpMaxSupply').textContent = `${fmt(maxSupply)} DP`;
        const ratio = (parseFloat(ethers.utils.formatEther(totalSupply)) / parseFloat(ethers.utils.formatEther(maxSupply)) * 100).toFixed(2);
        $('dpSupplyRatio').textContent = `${ratio}%`;
      } catch (e) {
        console.warn('DPToken è¯»å–å¤±è´¥:', e);
        // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
        $('dpVersion').textContent = 'è¯»å–å¤±è´¥';
        $('dpPaused').textContent = 'âŒ æ— æ³•è¿æ¥';
        $('dpPaused').style.color = '#ef4444';
        $('dpTotalSupply').textContent = '--';
        $('dpMaxSupply').textContent = '--';
        $('dpSupplyRatio').textContent = '--';
        $('btnDPPause').disabled = true;
        $('btnDPUnpause').disabled = true;
        setMsg('msgDPToken', 'âš ï¸ åˆçº¦åœ°å€å¯èƒ½æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥é…ç½®', false);
      }
    }

    async function refreshDebearPass() {
      if (!CONTRACTS.debearPass) {
        $('passVersion').textContent = 'æœªé…ç½®';
        $('passPaused').textContent = '--';
        return;
      }
      try {
        const debearPass = new ethers.Contract(CONTRACTS.debearPass, DEBEARPASS_ABI, provider);
        
        // å°è¯•è¯»å– V2 æ–¹æ³•ï¼ˆpaused, versionï¼‰
        let paused, version;
        try {
          [paused, version] = await Promise.all([
            debearPass.paused(),
            debearPass.version()
          ]);
        } catch (v2Error) {
          console.warn('DebearPass æœªå‡çº§åˆ° V2ï¼Œæš‚åœåŠŸèƒ½ä¸å¯ç”¨');
          paused = null;
          version = 'V1 (æœªå‡çº§)';
        }
        
        // æŸ¥è¯¢ç¨è´¹åœ°å€çš„ Pass ä½™é¢
        const [stdBalance, preBalance, exBalance] = await Promise.all([
          debearPass.balanceOf(TAX_RECIPIENT, 1),
          debearPass.balanceOf(TAX_RECIPIENT, 2),
          debearPass.balanceOf(TAX_RECIPIENT, 3)
        ]);
        
        $('passVersion').textContent = version;
        
        if (paused !== null) {
          $('passPaused').textContent = paused ? 'â›¸ï¸ å·²æš‚åœ' : 'âœ… è¿è¡Œä¸­';
          $('passPaused').style.color = paused ? '#fca5a5' : '#86efac';
          $('btnPassPause').disabled = paused;
          $('btnPassUnpause').disabled = !paused;
        } else {
          $('passPaused').textContent = 'ğŸ”„ éœ€å‡çº§åˆ° V2';
          $('passPaused').style.color = '#fbbf24';
          $('btnPassPause').disabled = true;
          $('btnPassUnpause').disabled = true;
        }
        
        // æ˜¾ç¤ºç¨è´¹åœ°å€çš„ä½™é¢
        $('passStandard').textContent = `å‰©ä½™ ${stdBalance.toString()} å¼ `;
        $('passPremium').textContent = `å‰©ä½™ ${preBalance.toString()} å¼ `;
        $('passExclusive').textContent = `å‰©ä½™ ${exBalance.toString()} å¼ `;
      } catch (e) {
        console.warn('DebearPass è¯»å–å¤±è´¥:', e);
        setMsg('msgDebearPass', 'è¯»å–å¤±è´¥: ' + (e?.message||e), false);
      }
    }

    $('btnDPPause').onclick = async () => {
      const reason = prompt('è¯·è¾“å…¥æš‚åœåŸå› :');
      if (!reason) return;
      try {
        const dpToken = await withSigner(CONTRACTS.dpToken, DPTOKEN_ABI);
        const tx = await dpToken.pause(reason);
        setMsg('msgDPToken', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgDPToken', 'âœ… DPToken å·²æš‚åœ');
        await refreshDPToken();
      } catch (e) { setMsg('msgDPToken', e?.message||String(e), false); }
    };

    $('btnDPUnpause').onclick = async () => {
      if (!confirm('ç¡®å®šè¦æ¢å¤ DPToken å—ï¼Ÿ')) return;
      try {
        const dpToken = await withSigner(CONTRACTS.dpToken, DPTOKEN_ABI);
        const tx = await dpToken.unpause();
        setMsg('msgDPToken', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgDPToken', 'âœ… DPToken å·²æ¢å¤');
        await refreshDPToken();
      } catch (e) { setMsg('msgDPToken', e?.message||String(e), false); }
    };

    $('btnPassPause').onclick = async () => {
      if (!confirm('ç¡®å®šè¦æš‚åœ DebearPass å—ï¼Ÿ')) return;
      try {
        const debearPass = await withSigner(CONTRACTS.debearPass, DEBEARPASS_ABI);
        const tx = await debearPass.pause();
        setMsg('msgDebearPass', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgDebearPass', 'âœ… DebearPass å·²æš‚åœ');
        await refreshDebearPass();
      } catch (e) { setMsg('msgDebearPass', e?.message||String(e), false); }
    };

    $('btnPassUnpause').onclick = async () => {
      if (!confirm('ç¡®å®šè¦æ¢å¤ DebearPass å—ï¼Ÿ')) return;
      try {
        const debearPass = await withSigner(CONTRACTS.debearPass, DEBEARPASS_ABI);
        const tx = await debearPass.unpause();
        setMsg('msgDebearPass', 'æäº¤äº¤æ˜“ä¸­...');
        await tx.wait();
        setMsg('msgDebearPass', 'âœ… DebearPass å·²æ¢å¤');
        await refreshDebearPass();
      } catch (e) { setMsg('msgDebearPass', e?.message||String(e), false); }
    };

    // å¿«é€Ÿè½¬å…¥ NFT æ± 
    async function depositToNFTPool() {
      try {
        const amt = ($('nftDepositAmount').value||'').trim();
        if (!amt || parseFloat(amt) <= 0) { setMsg('msgNFTPool', 'è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡', false); return; }
        const dp = await withSigner(CONTRACTS.dpToken, ERC20_ABI);
        const wei = ethers.utils.parseEther(amt);
        setMsg('msgNFTPool', 'æäº¤äº¤æ˜“ä¸­...');
        const tx = await dp.transfer(CONTRACTS.nftMiningPool, wei);
        await tx.wait();
        setMsg('msgNFTPool', 'è½¬å…¥æˆåŠŸ');
        $('nftDepositAmount').value = '';
        await refreshPoolBalances();
      } catch (e) { setMsg('msgNFTPool', e?.message||String(e), false); }
    }

    // å¿«é€Ÿè½¬å…¥ T-Engine æ± 
    async function depositToTEngine() {
      try {
        const amt = ($('tenDepositAmount').value||'').trim();
        if (!amt || parseFloat(amt) <= 0) { setMsg('msgTEnginePool', 'è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡', false); return; }
        const dp = await withSigner(CONTRACTS.dpToken, ERC20_ABI);
        const wei = ethers.utils.parseEther(amt);
        setMsg('msgTEnginePool', 'æäº¤äº¤æ˜“ä¸­...');
        const tx = await dp.transfer(CONTRACTS.tEngine, wei);
        await tx.wait();
        setMsg('msgTEnginePool', 'è½¬å…¥æˆåŠŸ');
        $('tenDepositAmount').value = '';
        await refreshPoolBalances();
      } catch (e) { setMsg('msgTEnginePool', e?.message||String(e), false); }
    }

    // Bind connect button
    $('connectBtn').onclick = connectWallet;
    
    // ğŸ”„ åˆ·æ–° BERA ä»·æ ¼æŒ‰é’®
    $('btnRefreshBeraPrice').onclick = async () => {
      cachedBeraPrice = null;  // æ¸…ç©ºç¼“å­˜
      await updateSuggestedPrices();
    };
    
    // é¡µé¢åˆå§‹åŒ–
    console.log('%cğŸ› ï¸ Debear Party - Owner æ§åˆ¶å°', 'color: #4f46e5; font-size: 20px; font-weight: bold;');
    console.log('%câœ… æ§åˆ¶å°è°ƒè¯•å·²å¯ç”¨', 'color: #10b981; font-weight: bold;');
    console.log('ğŸ“Š åˆçº¦åœ°å€:');
    console.table(CONTRACTS);
    console.log('ğŸ’¡ è¯·ç‚¹å‡» "è¿æ¥é’±åŒ…" æŒ‰é’®å¼€å§‹ä½¿ç”¨');
    console.log('ğŸ” å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—');
    
  </script>
</body>
</html>
